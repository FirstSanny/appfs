<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>appfs: /OPTI/bzfdinse/appfs/Dinsel/venv/lib/python3.5/site-packages/setuptools/command/easy_install.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">appfs
   &#160;<span id="projectnumber">1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_b51dbb6a9fdf705bef6f1d989db2f1ee.html">OPTI</a></li><li class="navelem"><a class="el" href="dir_26b9974e5b45d02070e599411d8cdb78.html">bzfdinse</a></li><li class="navelem"><a class="el" href="dir_14616f07bb336181b53dfe8f5d723bd0.html">appfs</a></li><li class="navelem"><a class="el" href="dir_ac212ff621c3d31cd8f53e0d5b8bf37b.html">Dinsel</a></li><li class="navelem"><a class="el" href="dir_83966e9ec3b7bb31abd44c7f5ce46ab3.html">venv</a></li><li class="navelem"><a class="el" href="dir_e13dc5a1a0c0104e598bfb1503bb915b.html">lib</a></li><li class="navelem"><a class="el" href="dir_d60bb951f0c174a459eada8277b369c9.html">python3.5</a></li><li class="navelem"><a class="el" href="dir_42b0a2b78d0a4f275f6b246b71d2076d.html">site-packages</a></li><li class="navelem"><a class="el" href="dir_916f3620a6aa604ebb618f7c3f7cd99d.html">setuptools</a></li><li class="navelem"><a class="el" href="dir_9e55d1dcd7f1f3e09fbf51e0a3667b15.html">command</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">easy_install.py</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#!/usr/bin/env python</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral">Easy Install</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral">------------</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral">A tool for doing automatic download/extract/build of distutils-based Python</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="stringliteral">packages.  For detailed documentation, see the accompanying EasyInstall.txt</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="stringliteral">file, or visit the `EasyInstall home page`__.</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="stringliteral">__ https://setuptools.readthedocs.io/en/latest/easy_install.html</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">from</span> glob <span class="keyword">import</span> glob</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">from</span> distutils.util <span class="keyword">import</span> get_platform</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">from</span> distutils.util <span class="keyword">import</span> convert_path, subst_vars</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">from</span> distutils.errors <span class="keyword">import</span> (</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    DistutilsArgError, DistutilsOptionError,</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    DistutilsError, DistutilsPlatformError,</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;)</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">from</span> distutils.command.install <span class="keyword">import</span> INSTALL_SCHEMES, SCHEME_KEYS</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">from</span> distutils <span class="keyword">import</span> log, dir_util</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">from</span> distutils.command.build_scripts <span class="keyword">import</span> first_line_re</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">from</span> distutils.spawn <span class="keyword">import</span> find_executable</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">import</span> sys</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">import</span> os</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">import</span> zipimport</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">import</span> shutil</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">import</span> tempfile</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">import</span> zipfile</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">import</span> re</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">import</span> stat</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">import</span> random</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">import</span> textwrap</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">import</span> warnings</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">import</span> site</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">import</span> struct</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">import</span> contextlib</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">import</span> subprocess</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">import</span> shlex</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">import</span> io</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1extern.html">setuptools.extern</a> <span class="keyword">import</span> six</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">from</span> setuptools.extern.six.moves <span class="keyword">import</span> configparser, map</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">from</span> setuptools <span class="keyword">import</span> Command</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1sandbox.html">setuptools.sandbox</a> <span class="keyword">import</span> run_setup</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1py31compat.html">setuptools.py31compat</a> <span class="keyword">import</span> get_path, get_config_vars</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1py27compat.html">setuptools.py27compat</a> <span class="keyword">import</span> rmtree_safe</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1command.html">setuptools.command</a> <span class="keyword">import</span> setopt</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1archive__util.html">setuptools.archive_util</a> <span class="keyword">import</span> unpack_archive</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1package__index.html">setuptools.package_index</a> <span class="keyword">import</span> (</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    PackageIndex, parse_requirement_arg, URL_SCHEME,</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;)</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1command.html">setuptools.command</a> <span class="keyword">import</span> bdist_egg, egg_info</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">from</span> pkg_resources <span class="keyword">import</span> (</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    yield_lines, normalize_path, resource_string, ensure_directory,</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    get_distribution, find_distributions, Environment, Requirement,</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    Distribution, PathMetadata, EggMetadata, WorkingSet, DistributionNotFound,</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    VersionConflict, DEVELOP_DIST,</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;)</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">import</span> pkg_resources</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"># Turn on PEP440Warnings</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;warnings.filterwarnings(<span class="stringliteral">&quot;default&quot;</span>, category=pkg_resources.PEP440Warning)</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;__all__ = [</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="stringliteral">&#39;samefile&#39;</span>, <span class="stringliteral">&#39;easy_install&#39;</span>, <span class="stringliteral">&#39;PthDistributions&#39;</span>, <span class="stringliteral">&#39;extract_wininst_cfg&#39;</span>,</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="stringliteral">&#39;main&#39;</span>, <span class="stringliteral">&#39;get_exe_prefixes&#39;</span>,</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;]</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="keyword">def </span>is_64bit():</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordflow">return</span> struct.calcsize(<span class="stringliteral">&quot;P&quot;</span>) == 8</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keyword">def </span>samefile(p1, p2):</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="stringliteral">    Determine if two paths reference the same file.</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="stringliteral">    Augments os.path.samefile to work on Windows and</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="stringliteral">    suppresses errors if the path doesn&#39;t exist.</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    both_exist = os.path.exists(p1) <span class="keywordflow">and</span> os.path.exists(p2)</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    use_samefile = hasattr(os.path, <span class="stringliteral">&#39;samefile&#39;</span>) <span class="keywordflow">and</span> both_exist</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordflow">if</span> use_samefile:</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="keywordflow">return</span> os.path.samefile(p1, p2)</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    norm_p1 = os.path.normpath(os.path.normcase(p1))</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    norm_p2 = os.path.normpath(os.path.normcase(p2))</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="keywordflow">return</span> norm_p1 == norm_p2</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="keywordflow">if</span> six.PY2:</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keyword">def </span>_to_ascii(s):</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        <span class="keywordflow">return</span> s</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keyword">def </span>isascii(s):</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            six.text_type(s, <span class="stringliteral">&#39;ascii&#39;</span>)</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <span class="keywordflow">except</span> UnicodeError:</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keyword">def </span>_to_ascii(s):</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="keywordflow">return</span> s.encode(<span class="stringliteral">&#39;ascii&#39;</span>)</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keyword">def </span>isascii(s):</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            s.encode(<span class="stringliteral">&#39;ascii&#39;</span>)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="keywordflow">except</span> UnicodeError:</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;_one_liner = <span class="keyword">lambda</span> text: textwrap.dedent(text).strip().replace(<span class="stringliteral">&#39;\n&#39;</span>, <span class="stringliteral">&#39;; &#39;</span>)</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="keyword">class </span><a class="code" href="namespaceeasy__install.html">easy_install</a>(Command):</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Manage a download/build/install process&quot;&quot;&quot;</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    description = <span class="stringliteral">&quot;Find/get/install Python packages&quot;</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    command_consumes_arguments = <span class="keyword">True</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    user_options = [</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        (<span class="stringliteral">&#39;prefix=&#39;</span>, <span class="keywordtype">None</span>, <span class="stringliteral">&quot;installation prefix&quot;</span>),</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        (<span class="stringliteral">&quot;zip-ok&quot;</span>, <span class="stringliteral">&quot;z&quot;</span>, <span class="stringliteral">&quot;install package as a zipfile&quot;</span>),</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        (<span class="stringliteral">&quot;multi-version&quot;</span>, <span class="stringliteral">&quot;m&quot;</span>, <span class="stringliteral">&quot;make apps have to require() a version&quot;</span>),</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        (<span class="stringliteral">&quot;upgrade&quot;</span>, <span class="stringliteral">&quot;U&quot;, &quot;</span>force upgrade (searches PyPI for latest versions)&quot;),        (<span class="stringliteral">&quot;install-dir=&quot;</span>, <span class="stringliteral">&quot;d&quot;</span>, <span class="stringliteral">&quot;install package to DIR&quot;</span>),</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        (<span class="stringliteral">&quot;script-dir=&quot;</span>, <span class="stringliteral">&quot;s&quot;</span>, <span class="stringliteral">&quot;install scripts to DIR&quot;</span>),</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        (<span class="stringliteral">&quot;exclude-scripts&quot;</span>, <span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;Don&#39;t install scripts&quot;</span>),</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        (<span class="stringliteral">&quot;always-copy&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>, <span class="stringliteral">&quot;Copy all needed packages to install dir&quot;</span>),</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        (<span class="stringliteral">&quot;index-url=&quot;</span>, <span class="stringliteral">&quot;i&quot;</span>, <span class="stringliteral">&quot;base URL of Python Package Index&quot;</span>),</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        (<span class="stringliteral">&quot;find-links=&quot;</span>, <span class="stringliteral">&quot;f&quot;</span>, <span class="stringliteral">&quot;additional URL(s) to search for packages&quot;</span>),</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        (<span class="stringliteral">&quot;build-directory=&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>,</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;         <span class="stringliteral">&quot;download/extract/build in DIR; keep the results&quot;</span>),</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        (<span class="stringliteral">&#39;optimize=&#39;</span>, <span class="stringliteral">&#39;O&#39;</span>,</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;         <span class="stringliteral">&quot;also compile with optimization: -O1 for \&quot;python -O\&quot;, &quot;</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;         <span class="stringliteral">&quot;-O2 for \&quot;python -OO\&quot;, and -O0 to disable [default: -O0]&quot;</span>),</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        (<span class="stringliteral">&#39;record=&#39;</span>, <span class="keywordtype">None</span>,</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;         <span class="stringliteral">&quot;filename in which to record list of installed files&quot;</span>),</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        (<span class="stringliteral">&#39;always-unzip&#39;</span>, <span class="stringliteral">&#39;Z&#39;</span>, <span class="stringliteral">&quot;don&#39;t install as a zipfile, no matter what&quot;</span>),</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        (<span class="stringliteral">&#39;site-dirs=&#39;</span>, <span class="stringliteral">&#39;S&#39;</span>, <span class="stringliteral">&quot;list of directories where .pth files work&quot;</span>),</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        (<span class="stringliteral">&#39;editable&#39;</span>, <span class="stringliteral">&#39;e&#39;</span>, <span class="stringliteral">&quot;Install specified packages in editable form&quot;</span>),</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        (<span class="stringliteral">&#39;no-deps&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, <span class="stringliteral">&quot;don&#39;t install dependencies&quot;</span>),</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        (<span class="stringliteral">&#39;allow-hosts=&#39;</span>, <span class="stringliteral">&#39;H&#39;</span>, <span class="stringliteral">&quot;pattern(s) that hostnames must match&quot;</span>),</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        (<span class="stringliteral">&#39;local-snapshots-ok&#39;</span>, <span class="stringliteral">&#39;l&#39;</span>,</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;         <span class="stringliteral">&quot;allow building eggs from local checkouts&quot;</span>),</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        (<span class="stringliteral">&#39;version&#39;</span>, <span class="keywordtype">None</span>, <span class="stringliteral">&quot;print version information and exit&quot;</span>),</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        (<span class="stringliteral">&#39;no-find-links&#39;</span>, <span class="keywordtype">None</span>,</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;         <span class="stringliteral">&quot;Don&#39;t load find-links defined in packages being installed&quot;</span>)</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    ]</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    boolean_options = [</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="stringliteral">&#39;zip-ok&#39;</span>, <span class="stringliteral">&#39;multi-version&#39;</span>, <span class="stringliteral">&#39;exclude-scripts&#39;</span>, <span class="stringliteral">&#39;upgrade&#39;</span>, <span class="stringliteral">&#39;always-copy&#39;</span>,</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="stringliteral">&#39;editable&#39;</span>,</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="stringliteral">&#39;no-deps&#39;</span>, <span class="stringliteral">&#39;local-snapshots-ok&#39;</span>, <span class="stringliteral">&#39;version&#39;</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    ]</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keywordflow">if</span> site.ENABLE_USER_SITE:</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        help_msg = <span class="stringliteral">&quot;install in user site-package &#39;%s&#39;&quot;</span> % site.USER_SITE</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        user_options.append((<span class="stringliteral">&#39;user&#39;</span>, <span class="keywordtype">None</span>, help_msg))</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        boolean_options.append(<span class="stringliteral">&#39;user&#39;</span>)</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    negative_opt = {<span class="stringliteral">&#39;always-unzip&#39;</span>: <span class="stringliteral">&#39;zip-ok&#39;</span>}</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    create_index = PackageIndex</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keyword">def </span>initialize_options(self):</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        <span class="comment"># the --user option seems to be an opt-in one,</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="comment"># so the default should be False.</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        self.user = 0</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        self.zip_ok = self.local_snapshots_ok = <span class="keywordtype">None</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        self.install_dir = self.script_dir = self.exclude_scripts = <span class="keywordtype">None</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        self.index_url = <span class="keywordtype">None</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        self.find_links = <span class="keywordtype">None</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        self.build_directory = <span class="keywordtype">None</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        self.args = <span class="keywordtype">None</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        self.optimize = self.record = <span class="keywordtype">None</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        self.upgrade = self.always_copy = self.multi_version = <span class="keywordtype">None</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        self.editable = self.no_deps = self.allow_hosts = <span class="keywordtype">None</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        self.root = self.prefix = self.no_report = <span class="keywordtype">None</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        self.version = <span class="keywordtype">None</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        self.install_purelib = <span class="keywordtype">None</span>  <span class="comment"># for pure module distributions</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        self.install_platlib = <span class="keywordtype">None</span>  <span class="comment"># non-pure (dists w/ extensions)</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        self.install_headers = <span class="keywordtype">None</span>  <span class="comment"># for C/C++ headers</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        self.install_lib = <span class="keywordtype">None</span>  <span class="comment"># set to either purelib or platlib</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        self.install_scripts = <span class="keywordtype">None</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        self.install_data = <span class="keywordtype">None</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        self.install_base = <span class="keywordtype">None</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        self.install_platbase = <span class="keywordtype">None</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keywordflow">if</span> site.ENABLE_USER_SITE:</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;            self.install_userbase = site.USER_BASE</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            self.install_usersite = site.USER_SITE</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            self.install_userbase = <span class="keywordtype">None</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            self.install_usersite = <span class="keywordtype">None</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        self.no_find_links = <span class="keywordtype">None</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="comment"># Options not specifiable via command line</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        self.package_index = <span class="keywordtype">None</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        self.pth_file = self.always_copy_from = <span class="keywordtype">None</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        self.site_dirs = <span class="keywordtype">None</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        self.installed_projects = {}</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        self.sitepy_installed = <span class="keyword">False</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <span class="comment"># Always read easy_install options, even if we are subclassed, or have</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <span class="comment"># an independent instance created.  This ensures that defaults will</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="comment"># always come from the standard configuration file(s)&#39; &quot;easy_install&quot;</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="comment"># section, even if this is a &quot;develop&quot; or &quot;install&quot; command, or some</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment"># other embedding.</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        self._dry_run = <span class="keywordtype">None</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        self.verbose = self.distribution.verbose</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        self.distribution._set_command_options(</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            self, self.distribution.get_option_dict(<span class="stringliteral">&#39;easy_install&#39;</span>)</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        )</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keyword">def </span>delete_blockers(self, blockers):</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        extant_blockers = (</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            filename <span class="keywordflow">for</span> filename <span class="keywordflow">in</span> blockers</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            <span class="keywordflow">if</span> os.path.exists(filename) <span class="keywordflow">or</span> os.path.islink(filename)</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        )</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        list(map(self._delete_path, extant_blockers))</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keyword">def </span>_delete_path(self, path):</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        log.info(<span class="stringliteral">&quot;Deleting %s&quot;</span>, path)</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordflow">if</span> self.dry_run:</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        is_tree = os.path.isdir(path) <span class="keywordflow">and</span> <span class="keywordflow">not</span> os.path.islink(path)</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        remover = rmtree <span class="keywordflow">if</span> is_tree <span class="keywordflow">else</span> os.unlink</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        remover(path)</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    @staticmethod</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keyword">def </span>_render_version():</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="stringliteral">        Render the Setuptools version and installation details, then exit.</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        ver = sys.version[:3]</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        dist = get_distribution(<span class="stringliteral">&#39;setuptools&#39;</span>)</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        tmpl = <span class="stringliteral">&#39;setuptools {dist.version} from {dist.location} (Python {ver})&#39;</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        print(tmpl.format(**locals()))</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="keywordflow">raise</span> SystemExit()</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="keyword">def </span>finalize_options(self):</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        self.version <span class="keywordflow">and</span> self._render_version()</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        py_version = sys.version.split()[0]</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        prefix, exec_prefix = get_config_vars(<span class="stringliteral">&#39;prefix&#39;</span>, <span class="stringliteral">&#39;exec_prefix&#39;</span>)</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        self.config_vars = {</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            <span class="stringliteral">&#39;dist_name&#39;</span>: self.distribution.get_name(),</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            <span class="stringliteral">&#39;dist_version&#39;</span>: self.distribution.get_version(),</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            <span class="stringliteral">&#39;dist_fullname&#39;</span>: self.distribution.get_fullname(),</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            <span class="stringliteral">&#39;py_version&#39;</span>: py_version,</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            <span class="stringliteral">&#39;py_version_short&#39;</span>: py_version[0:3],</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            <span class="stringliteral">&#39;py_version_nodot&#39;</span>: py_version[0] + py_version[2],</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;            <span class="stringliteral">&#39;sys_prefix&#39;</span>: prefix,</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="stringliteral">&#39;prefix&#39;</span>: prefix,</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            <span class="stringliteral">&#39;sys_exec_prefix&#39;</span>: exec_prefix,</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="stringliteral">&#39;exec_prefix&#39;</span>: exec_prefix,</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            <span class="comment"># Only python 3.2+ has abiflags</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            <span class="stringliteral">&#39;abiflags&#39;</span>: getattr(sys, <span class="stringliteral">&#39;abiflags&#39;</span>, <span class="stringliteral">&#39;&#39;</span>),</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        }</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="keywordflow">if</span> site.ENABLE_USER_SITE:</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            self.config_vars[<span class="stringliteral">&#39;userbase&#39;</span>] = self.install_userbase</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            self.config_vars[<span class="stringliteral">&#39;usersite&#39;</span>] = self.install_usersite</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        self._fix_install_dir_for_user_site()</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        self.expand_basedirs()</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        self.expand_dirs()</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        self._expand(</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            <span class="stringliteral">&#39;install_dir&#39;</span>, <span class="stringliteral">&#39;script_dir&#39;</span>, <span class="stringliteral">&#39;build_directory&#39;</span>,</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            <span class="stringliteral">&#39;site_dirs&#39;</span>,</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        )</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        <span class="comment"># If a non-default installation directory was specified, default the</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="comment"># script directory to match it.</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="keywordflow">if</span> self.script_dir <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            self.script_dir = self.install_dir</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <span class="keywordflow">if</span> self.no_find_links <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            self.no_find_links = <span class="keyword">False</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="comment"># Let install_dir get set by install_lib command, which in turn</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="comment"># gets its info from the install command, and takes into account</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        <span class="comment"># --prefix and --home and all that other crud.</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        self.set_undefined_options(</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            <span class="stringliteral">&#39;install_lib&#39;</span>, (<span class="stringliteral">&#39;install_dir&#39;</span>, <span class="stringliteral">&#39;install_dir&#39;</span>)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        )</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="comment"># Likewise, set default script_dir from &#39;install_scripts.install_dir&#39;</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        self.set_undefined_options(</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            <span class="stringliteral">&#39;install_scripts&#39;</span>, (<span class="stringliteral">&#39;install_dir&#39;</span>, <span class="stringliteral">&#39;script_dir&#39;</span>)</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        )</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordflow">if</span> self.user <span class="keywordflow">and</span> self.install_purelib:</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            self.install_dir = self.install_purelib</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            self.script_dir = self.install_scripts</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="comment"># default --record from the install command</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        self.set_undefined_options(<span class="stringliteral">&#39;install&#39;</span>, (<span class="stringliteral">&#39;record&#39;</span>, <span class="stringliteral">&#39;record&#39;</span>))</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="comment"># Should this be moved to the if statement below? It&#39;s not used</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        <span class="comment"># elsewhere</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        normpath = map(normalize_path, sys.path)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        self.all_site_dirs = get_site_dirs()</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <span class="keywordflow">if</span> self.site_dirs <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            site_dirs = [</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                os.path.expanduser(s.strip()) <span class="keywordflow">for</span> s <span class="keywordflow">in</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                self.site_dirs.split(<span class="stringliteral">&#39;,&#39;</span>)</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            ]</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            <span class="keywordflow">for</span> d <span class="keywordflow">in</span> site_dirs:</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.isdir(d):</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    log.warn(<span class="stringliteral">&quot;%s (in --site-dirs) does not exist&quot;</span>, d)</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                <span class="keywordflow">elif</span> normalize_path(d) <span class="keywordflow">not</span> <span class="keywordflow">in</span> normpath:</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                    <span class="keywordflow">raise</span> DistutilsOptionError(</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                        d + <span class="stringliteral">&quot; (in --site-dirs) is not on sys.path&quot;</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    )</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                    self.all_site_dirs.append(normalize_path(d))</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.editable:</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            self.check_site_dir()</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        self.index_url = self.index_url <span class="keywordflow">or</span> <span class="stringliteral">&quot;https://pypi.python.org/simple&quot;</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        self.shadow_path = self.all_site_dirs[:]</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="keywordflow">for</span> path_item <span class="keywordflow">in</span> self.install_dir, normalize_path(self.script_dir):</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <span class="keywordflow">if</span> path_item <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.shadow_path:</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                self.shadow_path.insert(0, path_item)</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">if</span> self.allow_hosts <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            hosts = [s.strip() <span class="keywordflow">for</span> s <span class="keywordflow">in</span> self.allow_hosts.split(<span class="stringliteral">&#39;,&#39;</span>)]</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            hosts = [<span class="stringliteral">&#39;*&#39;</span>]</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="keywordflow">if</span> self.package_index <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            self.package_index = self.create_index(</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                self.index_url, search_path=self.shadow_path, hosts=hosts,</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            )</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        self.local_index = Environment(self.shadow_path + sys.path)</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="keywordflow">if</span> self.find_links <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            <span class="keywordflow">if</span> isinstance(self.find_links, six.string_types):</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                self.find_links = self.find_links.split()</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            self.find_links = []</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        <span class="keywordflow">if</span> self.local_snapshots_ok:</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            self.package_index.scan_egg_links(self.shadow_path + sys.path)</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.no_find_links:</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            self.package_index.add_find_links(self.find_links)</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        self.set_undefined_options(<span class="stringliteral">&#39;install_lib&#39;</span>, (<span class="stringliteral">&#39;optimize&#39;</span>, <span class="stringliteral">&#39;optimize&#39;</span>))</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(self.optimize, int):</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                self.optimize = int(self.optimize)</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> (0 &lt;= self.optimize &lt;= 2):</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                    <span class="keywordflow">raise</span> ValueError</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            <span class="keywordflow">except</span> ValueError:</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                <span class="keywordflow">raise</span> DistutilsOptionError(<span class="stringliteral">&quot;--optimize must be 0, 1, or 2&quot;</span>)</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <span class="keywordflow">if</span> self.editable <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.build_directory:</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            <span class="keywordflow">raise</span> DistutilsArgError(</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                <span class="stringliteral">&quot;Must specify a build directory (-b) when using --editable&quot;</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            )</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.args:</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            <span class="keywordflow">raise</span> DistutilsArgError(</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                <span class="stringliteral">&quot;No urls, filenames, or requirements specified (see --help)&quot;</span>)</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        self.outputs = []</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="keyword">def </span>_fix_install_dir_for_user_site(self):</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="stringliteral">        Fix the install_dir if &quot;--user&quot; was used.</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.user <span class="keywordflow">or</span> <span class="keywordflow">not</span> site.ENABLE_USER_SITE:</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        self.create_home_path()</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="keywordflow">if</span> self.install_userbase <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            msg = <span class="stringliteral">&quot;User base directory is not specified&quot;</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="keywordflow">raise</span> DistutilsPlatformError(msg)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        self.install_base = self.install_platbase = self.install_userbase</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        scheme_name = os.name.replace(<span class="stringliteral">&#39;posix&#39;</span>, <span class="stringliteral">&#39;unix&#39;</span>) + <span class="stringliteral">&#39;_user&#39;</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        self.select_scheme(scheme_name)</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keyword">def </span>_expand_attrs(self, attrs):</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="keywordflow">for</span> attr <span class="keywordflow">in</span> attrs:</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            val = getattr(self, attr)</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            <span class="keywordflow">if</span> val <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                <span class="keywordflow">if</span> os.name == <span class="stringliteral">&#39;posix&#39;</span> <span class="keywordflow">or</span> os.name == <span class="stringliteral">&#39;nt&#39;</span>:</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                    val = os.path.expanduser(val)</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                val = subst_vars(val, self.config_vars)</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                setattr(self, attr, val)</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keyword">def </span>expand_basedirs(self):</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Calls `os.path.expanduser` on install_base, install_platbase and</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="stringliteral">        root.&quot;&quot;&quot;</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        self._expand_attrs([<span class="stringliteral">&#39;install_base&#39;</span>, <span class="stringliteral">&#39;install_platbase&#39;</span>, <span class="stringliteral">&#39;root&#39;</span>])</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keyword">def </span>expand_dirs(self):</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Calls `os.path.expanduser` on install dirs.&quot;&quot;&quot;</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        dirs = [</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            <span class="stringliteral">&#39;install_purelib&#39;</span>,</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            <span class="stringliteral">&#39;install_platlib&#39;</span>,</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            <span class="stringliteral">&#39;install_lib&#39;</span>,</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            <span class="stringliteral">&#39;install_headers&#39;</span>,</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            <span class="stringliteral">&#39;install_scripts&#39;</span>,</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            <span class="stringliteral">&#39;install_data&#39;</span>,</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        ]</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        self._expand_attrs(dirs)</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keyword">def </span>run(self):</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">if</span> self.verbose != self.distribution.verbose:</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            log.set_verbosity(self.verbose)</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            <span class="keywordflow">for</span> spec <span class="keywordflow">in</span> self.args:</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                self.easy_install(spec, <span class="keywordflow">not</span> self.no_deps)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            <span class="keywordflow">if</span> self.record:</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                outputs = self.outputs</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                <span class="keywordflow">if</span> self.root:  <span class="comment"># strip any package prefix</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                    root_len = len(self.root)</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                    <span class="keywordflow">for</span> counter <span class="keywordflow">in</span> range(len(outputs)):</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                        outputs[counter] = outputs[counter][root_len:]</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                <span class="keyword">from</span> distutils <span class="keyword">import</span> file_util</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                self.execute(</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                    file_util.write_file, (self.record, outputs),</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                    <span class="stringliteral">&quot;writing list of installed files to &#39;%s&#39;&quot;</span> %</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                    self.record</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                )</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            self.warn_deprecated_options()</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="keywordflow">finally</span>:</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            log.set_verbosity(self.distribution.verbose)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="keyword">def </span>pseudo_tempname(self):</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Return a pseudo-tempname base in the install directory.</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="stringliteral">        This code is intentionally naive; if a malicious party can write to</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="stringliteral">        the target directory you&#39;re already in deep doodoo.</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            pid = os.getpid()</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordflow">except</span> Exception:</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            pid = random.randint(0, sys.maxsize)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="keywordflow">return</span> os.path.join(self.install_dir, <span class="stringliteral">&quot;test-easy-install-%s&quot;</span> % pid)</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="keyword">def </span>warn_deprecated_options(self):</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        <span class="keywordflow">pass</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keyword">def </span>check_site_dir(self):</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Verify that self.install_dir is .pth-capable dir, if needed&quot;&quot;&quot;</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        instdir = normalize_path(self.install_dir)</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        pth_file = os.path.join(instdir, <span class="stringliteral">&#39;easy-install.pth&#39;</span>)</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        <span class="comment"># Is it a configured, PYTHONPATH, implicit, or explicit site dir?</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        is_site_dir = instdir <span class="keywordflow">in</span> self.all_site_dirs</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> is_site_dir <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.multi_version:</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <span class="comment"># No?  Then directly test whether it does .pth file processing</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            is_site_dir = self.check_pth_processing()</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            <span class="comment"># make sure we can write to target dir</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            testfile = self.pseudo_tempname() + <span class="stringliteral">&#39;.write-test&#39;</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            test_exists = os.path.exists(testfile)</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="keywordflow">if</span> test_exists:</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                    os.unlink(testfile)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                open(testfile, <span class="stringliteral">&#39;w&#39;</span>).close()</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                os.unlink(testfile)</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            <span class="keywordflow">except</span> (OSError, IOError):</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                self.cant_write_to_target()</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> is_site_dir <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.multi_version:</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;            <span class="comment"># Can&#39;t install non-multi to non-site dir</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;            <span class="keywordflow">raise</span> DistutilsError(self.no_default_version_msg())</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordflow">if</span> is_site_dir:</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            <span class="keywordflow">if</span> self.pth_file <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                self.pth_file = PthDistributions(pth_file, self.all_site_dirs)</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;            self.pth_file = <span class="keywordtype">None</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="keywordflow">if</span> instdir <span class="keywordflow">not</span> <span class="keywordflow">in</span> map(normalize_path, _pythonpath()):</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            <span class="comment"># only PYTHONPATH dirs need a site.py, so pretend it&#39;s there</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            self.sitepy_installed = <span class="keyword">True</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="keywordflow">elif</span> self.multi_version <span class="keywordflow">and</span> <span class="keywordflow">not</span> os.path.exists(pth_file):</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            self.sitepy_installed = <span class="keyword">True</span>  <span class="comment"># don&#39;t need site.py in this case</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;            self.pth_file = <span class="keywordtype">None</span>  <span class="comment"># and don&#39;t create a .pth file</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        self.install_dir = instdir</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    __cant_write_msg = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="stringliteral">        can&#39;t create or remove files in install directory</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="stringliteral">        The following error occurred while trying to add or remove files in the</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;<span class="stringliteral">        installation directory:</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="stringliteral">            %s</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="stringliteral">        The installation directory you specified (via --install-dir, --prefix, or</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="stringliteral">        the distutils default setting) was:</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="stringliteral">            %s</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    __not_exists_id = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="stringliteral">        This directory does not currently exist.  Please create it and try again, or</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="stringliteral">        choose a different installation directory (using the -d or --install-dir</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="stringliteral">        option).</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    __access_msg = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="stringliteral">        Perhaps your account does not have write access to this directory?  If the</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="stringliteral">        installation directory is a system-owned directory, you may need to sign in</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="stringliteral">        as the administrator or &quot;root&quot; account.  If you do not have administrative</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="stringliteral">        access to this machine, you may wish to choose a different installation</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="stringliteral">        directory, preferably one that is listed in your PYTHONPATH environment</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="stringliteral">        variable.</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="stringliteral">        For information on other options, you may wish to consult the</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="stringliteral">        documentation at:</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="stringliteral">          https://setuptools.readthedocs.io/en/latest/easy_install.html</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="stringliteral">        Please make the appropriate changes for your system and try again.</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="keyword">def </span>cant_write_to_target(self):</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        msg = self.__cant_write_msg % (sys.exc_info()[1], self.install_dir,)</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(self.install_dir):</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            msg += <span class="stringliteral">&#39;\n&#39;</span> + self.__not_exists_id</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            msg += <span class="stringliteral">&#39;\n&#39;</span> + self.__access_msg</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <span class="keywordflow">raise</span> DistutilsError(msg)</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keyword">def </span>check_pth_processing(self):</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Empirically verify whether .pth files are supported in inst. dir&quot;&quot;&quot;</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        instdir = self.install_dir</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        log.info(<span class="stringliteral">&quot;Checking .pth file support in %s&quot;</span>, instdir)</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        pth_file = self.pseudo_tempname() + <span class="stringliteral">&quot;.pth&quot;</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        ok_file = pth_file + <span class="stringliteral">&#39;.ok&#39;</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        ok_exists = os.path.exists(ok_file)</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        tmpl = _one_liner(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="stringliteral">            import os</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="stringliteral">            f = open({ok_file!r}, &#39;w&#39;)</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="stringliteral">            f.write(&#39;OK&#39;)</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="stringliteral">            f.close()</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="stringliteral">            &quot;&quot;&quot;</span>) + <span class="stringliteral">&#39;\n&#39;</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            <span class="keywordflow">if</span> ok_exists:</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                os.unlink(ok_file)</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            dirname = os.path.dirname(ok_file)</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(dirname):</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                os.makedirs(dirname)</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            f = open(pth_file, <span class="stringliteral">&#39;w&#39;</span>)</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="keywordflow">except</span> (OSError, IOError):</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            self.cant_write_to_target()</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                f.write(tmpl.format(**locals()))</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                f.close()</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                f = <span class="keywordtype">None</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                executable = sys.executable</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                <span class="keywordflow">if</span> os.name == <span class="stringliteral">&#39;nt&#39;</span>:</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                    dirname, basename = os.path.split(executable)</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                    alt = os.path.join(dirname, <span class="stringliteral">&#39;pythonw.exe&#39;</span>)</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                    use_alt = (</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                        basename.lower() == <span class="stringliteral">&#39;python.exe&#39;</span> <span class="keywordflow">and</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                        os.path.exists(alt)</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                    )</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                    <span class="keywordflow">if</span> use_alt:</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                        <span class="comment"># use pythonw.exe to avoid opening a console window</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                        executable = alt</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                <span class="keyword">from</span> distutils.spawn <span class="keyword">import</span> spawn</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                spawn([executable, <span class="stringliteral">&#39;-E&#39;</span>, <span class="stringliteral">&#39;-c&#39;</span>, <span class="stringliteral">&#39;pass&#39;</span>], 0)</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                <span class="keywordflow">if</span> os.path.exists(ok_file):</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                    log.info(</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                        <span class="stringliteral">&quot;TEST PASSED: %s appears to support .pth files&quot;</span>,</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                        instdir</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                    )</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">True</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;            <span class="keywordflow">finally</span>:</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                <span class="keywordflow">if</span> f:</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                    f.close()</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                <span class="keywordflow">if</span> os.path.exists(ok_file):</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                    os.unlink(ok_file)</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                <span class="keywordflow">if</span> os.path.exists(pth_file):</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                    os.unlink(pth_file)</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.multi_version:</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;            log.warn(<span class="stringliteral">&quot;TEST FAILED: %s does NOT support .pth files&quot;</span>, instdir)</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keyword">def </span>install_egg_scripts(self, dist):</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Write all the scripts for `dist`, unless scripts are excluded&quot;&quot;&quot;</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.exclude_scripts <span class="keywordflow">and</span> dist.metadata_isdir(<span class="stringliteral">&#39;scripts&#39;</span>):</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="keywordflow">for</span> script_name <span class="keywordflow">in</span> dist.metadata_listdir(<span class="stringliteral">&#39;scripts&#39;</span>):</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                <span class="keywordflow">if</span> dist.metadata_isdir(<span class="stringliteral">&#39;scripts/&#39;</span> + script_name):</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                    <span class="comment"># The &quot;script&quot; is a directory, likely a Python 3</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                    <span class="comment"># __pycache__ directory, so skip it.</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                    <span class="keywordflow">continue</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                self.install_script(</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                    dist, script_name,</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                    dist.get_metadata(<span class="stringliteral">&#39;scripts/&#39;</span> + script_name)</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                )</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        self.install_wrapper_scripts(dist)</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="keyword">def </span>add_output(self, path):</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="keywordflow">if</span> os.path.isdir(path):</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            <span class="keywordflow">for</span> base, dirs, files <span class="keywordflow">in</span> os.walk(path):</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                <span class="keywordflow">for</span> filename <span class="keywordflow">in</span> files:</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                    self.outputs.append(os.path.join(base, filename))</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            self.outputs.append(path)</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="keyword">def </span>not_editable(self, spec):</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        <span class="keywordflow">if</span> self.editable:</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keywordflow">raise</span> DistutilsArgError(</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                <span class="stringliteral">&quot;Invalid argument %r: you can&#39;t use filenames or URLs &quot;</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                <span class="stringliteral">&quot;with --editable (except via the --find-links option).&quot;</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                % (spec,)</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            )</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="keyword">def </span>check_editable(self, spec):</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.editable:</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        <span class="keywordflow">if</span> os.path.exists(os.path.join(self.build_directory, spec.key)):</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;            <span class="keywordflow">raise</span> DistutilsArgError(</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                <span class="stringliteral">&quot;%r already exists in %s; can&#39;t do a checkout there&quot;</span> %</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                (spec.key, self.build_directory)</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            )</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    @contextlib.contextmanager</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="keyword">def </span>_tmpdir(self):</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        tmpdir = tempfile.mkdtemp(prefix=six.u(<span class="stringliteral">&quot;easy_install-&quot;</span>))</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            <span class="comment"># cast to str as workaround for #709 and #710 and #712</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordflow">yield</span> str(tmpdir)</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="keywordflow">finally</span>:</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            os.path.exists(tmpdir) <span class="keywordflow">and</span> rmtree(rmtree_safe(tmpdir))</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keyword">def </span><a class="code" href="namespaceeasy__install.html">easy_install</a>(self, spec, deps=False):</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.editable:</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;            self.install_site_py()</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        with self._tmpdir() <span class="keyword">as</span> tmpdir:</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(spec, Requirement):</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                <span class="keywordflow">if</span> URL_SCHEME(spec):</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                    <span class="comment"># It&#39;s a url, download it to tmpdir and process</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                    self.not_editable(spec)</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                    dl = self.package_index.download(spec, tmpdir)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                    <span class="keywordflow">return</span> self.install_item(<span class="keywordtype">None</span>, dl, tmpdir, deps, <span class="keyword">True</span>)</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                <span class="keywordflow">elif</span> os.path.exists(spec):</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                    <span class="comment"># Existing file or directory, just process it directly</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                    self.not_editable(spec)</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                    <span class="keywordflow">return</span> self.install_item(<span class="keywordtype">None</span>, spec, tmpdir, deps, <span class="keyword">True</span>)</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                    spec = parse_requirement_arg(spec)</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            self.check_editable(spec)</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            dist = self.package_index.fetch_distribution(</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                spec, tmpdir, self.upgrade, self.editable,</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                <span class="keywordflow">not</span> self.always_copy, self.local_index</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;            )</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            <span class="keywordflow">if</span> dist <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                msg = <span class="stringliteral">&quot;Could not find suitable distribution for %r&quot;</span> % spec</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                <span class="keywordflow">if</span> self.always_copy:</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                    msg += <span class="stringliteral">&quot; (--always-copy skips system and development eggs)&quot;</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                <span class="keywordflow">raise</span> DistutilsError(msg)</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;            <span class="keywordflow">elif</span> dist.precedence == DEVELOP_DIST:</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                <span class="comment"># .egg-info dists don&#39;t need installing, just process deps</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                self.process_distribution(spec, dist, deps, <span class="stringliteral">&quot;Using&quot;</span>)</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                <span class="keywordflow">return</span> dist</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                <span class="keywordflow">return</span> self.install_item(spec, dist.location, tmpdir, deps)</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="keyword">def </span>install_item(self, spec, download, tmpdir, deps, install_needed=False):</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        <span class="comment"># Installation is also needed if file in tmpdir or is not an egg</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        install_needed = install_needed <span class="keywordflow">or</span> self.always_copy</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        install_needed = install_needed <span class="keywordflow">or</span> os.path.dirname(download) == tmpdir</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        install_needed = install_needed <span class="keywordflow">or</span> <span class="keywordflow">not</span> download.endswith(<span class="stringliteral">&#39;.egg&#39;</span>)</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        install_needed = install_needed <span class="keywordflow">or</span> (</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            self.always_copy_from <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            os.path.dirname(normalize_path(download)) ==</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            normalize_path(self.always_copy_from)</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        )</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="keywordflow">if</span> spec <span class="keywordflow">and</span> <span class="keywordflow">not</span> install_needed:</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="comment"># at this point, we know it&#39;s a local .egg, we just don&#39;t know if</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            <span class="comment"># it&#39;s already installed.</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            <span class="keywordflow">for</span> dist <span class="keywordflow">in</span> self.local_index[spec.project_name]:</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;                <span class="keywordflow">if</span> dist.location == download:</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                    <span class="keywordflow">break</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                install_needed = <span class="keyword">True</span>  <span class="comment"># it&#39;s not in the local index</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        log.info(<span class="stringliteral">&quot;Processing %s&quot;</span>, os.path.basename(download))</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">if</span> install_needed:</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            dists = self.install_eggs(spec, download, tmpdir)</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            <span class="keywordflow">for</span> dist <span class="keywordflow">in</span> dists:</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                self.process_distribution(spec, dist, deps)</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;            dists = [self.egg_distribution(download)]</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            self.process_distribution(spec, dists[0], deps, <span class="stringliteral">&quot;Using&quot;</span>)</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <span class="keywordflow">if</span> spec <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;            <span class="keywordflow">for</span> dist <span class="keywordflow">in</span> dists:</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                <span class="keywordflow">if</span> dist <span class="keywordflow">in</span> spec:</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                    <span class="keywordflow">return</span> dist</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    <span class="keyword">def </span>select_scheme(self, name):</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Sets the install directories by applying the install schemes.&quot;&quot;&quot;</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="comment"># it&#39;s the caller&#39;s problem if they supply a bad name!</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        scheme = INSTALL_SCHEMES[name]</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> SCHEME_KEYS:</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            attrname = <span class="stringliteral">&#39;install_&#39;</span> + key</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;            <span class="keywordflow">if</span> getattr(self, attrname) <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                setattr(self, attrname, scheme[key])</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <span class="keyword">def </span>process_distribution(self, requirement, dist, deps=True, *info):</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        self.update_pth(dist)</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        self.package_index.add(dist)</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        <span class="keywordflow">if</span> dist <span class="keywordflow">in</span> self.local_index[dist.key]:</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;            self.local_index.remove(dist)</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        self.local_index.add(dist)</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        self.install_egg_scripts(dist)</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        self.installed_projects[dist.key] = dist</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        log.info(self.installation_report(requirement, dist, *info))</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        <span class="keywordflow">if</span> (dist.has_metadata(<span class="stringliteral">&#39;dependency_links.txt&#39;</span>) <span class="keywordflow">and</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                <span class="keywordflow">not</span> self.no_find_links):</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;            self.package_index.add_find_links(</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                dist.get_metadata_lines(<span class="stringliteral">&#39;dependency_links.txt&#39;</span>)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;            )</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> deps <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.always_copy:</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <span class="keywordflow">elif</span> requirement <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> dist.key != requirement.key:</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;            log.warn(<span class="stringliteral">&quot;Skipping dependencies for %s&quot;</span>, dist)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            <span class="keywordflow">return</span>  <span class="comment"># XXX this is not the distribution we were looking for</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">elif</span> requirement <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> dist <span class="keywordflow">not</span> <span class="keywordflow">in</span> requirement:</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            <span class="comment"># if we wound up with a different version, resolve what we&#39;ve got</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            distreq = dist.as_requirement()</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;            requirement = Requirement(str(distreq))</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        log.info(<span class="stringliteral">&quot;Processing dependencies for %s&quot;</span>, requirement)</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;            distros = WorkingSet([]).resolve(</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                [requirement], self.local_index, self.easy_install</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            )</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="keywordflow">except</span> DistributionNotFound <span class="keyword">as</span> e:</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            <span class="keywordflow">raise</span> DistutilsError(str(e))</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        <span class="keywordflow">except</span> VersionConflict <span class="keyword">as</span> e:</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;            <span class="keywordflow">raise</span> DistutilsError(e.report())</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <span class="keywordflow">if</span> self.always_copy <span class="keywordflow">or</span> self.always_copy_from:</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;            <span class="comment"># Force all the relevant distros to be copied or activated</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;            <span class="keywordflow">for</span> dist <span class="keywordflow">in</span> distros:</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                <span class="keywordflow">if</span> dist.key <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.installed_projects:</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                    self.easy_install(dist.as_requirement())</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        log.info(<span class="stringliteral">&quot;Finished processing dependencies for %s&quot;</span>, requirement)</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="keyword">def </span>should_unzip(self, dist):</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="keywordflow">if</span> self.zip_ok <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            <span class="keywordflow">return</span> <span class="keywordflow">not</span> self.zip_ok</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="keywordflow">if</span> dist.has_metadata(<span class="stringliteral">&#39;not-zip-safe&#39;</span>):</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> dist.has_metadata(<span class="stringliteral">&#39;zip-safe&#39;</span>):</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keyword">def </span>maybe_move(self, spec, dist_filename, setup_base):</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        dst = os.path.join(self.build_directory, spec.key)</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        <span class="keywordflow">if</span> os.path.exists(dst):</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            msg = (</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                <span class="stringliteral">&quot;%r already exists in %s; build directory %s will not be kept&quot;</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;            )</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            log.warn(msg, spec.key, self.build_directory, setup_base)</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            <span class="keywordflow">return</span> setup_base</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="keywordflow">if</span> os.path.isdir(dist_filename):</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            setup_base = dist_filename</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;            <span class="keywordflow">if</span> os.path.dirname(dist_filename) == setup_base:</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                os.unlink(dist_filename)  <span class="comment"># get it out of the tmp dir</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;            contents = os.listdir(setup_base)</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;            <span class="keywordflow">if</span> len(contents) == 1:</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                dist_filename = os.path.join(setup_base, contents[0])</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                <span class="keywordflow">if</span> os.path.isdir(dist_filename):</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                    <span class="comment"># if the only thing there is a directory, move it instead</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                    setup_base = dist_filename</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        ensure_directory(dst)</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        shutil.move(setup_base, dst)</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        <span class="keywordflow">return</span> dst</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="keyword">def </span>install_wrapper_scripts(self, dist):</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        <span class="keywordflow">if</span> self.exclude_scripts:</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        <span class="keywordflow">for</span> args <span class="keywordflow">in</span> ScriptWriter.best().get_args(dist):</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;            self.write_script(*args)</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="keyword">def </span>install_script(self, dist, script_name, script_text, dev_path=None):</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Generate a legacy script wrapper and install it&quot;&quot;&quot;</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        spec = str(dist.as_requirement())</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        is_script = is_python_script(script_text, script_name)</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        <span class="keywordflow">if</span> is_script:</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;            body = self._load_template(dev_path) % locals()</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;            script_text = ScriptWriter.get_header(script_text) + body</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        self.write_script(script_name, _to_ascii(script_text), <span class="stringliteral">&#39;b&#39;</span>)</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    @staticmethod</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="keyword">def </span>_load_template(dev_path):</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="stringliteral">        There are a couple of template scripts in the package. This</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="stringliteral">        function loads one of them and prepares it for use.</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        <span class="comment"># See https://github.com/pypa/setuptools/issues/134 for info</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        <span class="comment"># on script file naming and downstream issues with SVR4</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        name = <span class="stringliteral">&#39;script.tmpl&#39;</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        <span class="keywordflow">if</span> dev_path:</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            name = name.replace(<span class="stringliteral">&#39;.tmpl&#39;</span>, <span class="stringliteral">&#39; (dev).tmpl&#39;</span>)</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        raw_bytes = resource_string(<span class="stringliteral">&#39;setuptools&#39;</span>, name)</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        <span class="keywordflow">return</span> raw_bytes.decode(<span class="stringliteral">&#39;utf-8&#39;</span>)</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="keyword">def </span>write_script(self, script_name, contents, mode=&quot;t&quot;, blockers=()):</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Write an executable file to the scripts directory&quot;&quot;&quot;</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        self.delete_blockers(  <span class="comment"># clean up old .py/.pyw w/o a script</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;            [os.path.join(self.script_dir, x) <span class="keywordflow">for</span> x <span class="keywordflow">in</span> blockers]</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        )</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        log.info(<span class="stringliteral">&quot;Installing %s script to %s&quot;</span>, script_name, self.script_dir)</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        target = os.path.join(self.script_dir, script_name)</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        self.add_output(target)</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;        mask = current_umask()</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.dry_run:</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;            ensure_directory(target)</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;            <span class="keywordflow">if</span> os.path.exists(target):</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                os.unlink(target)</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;            with open(target, <span class="stringliteral">&quot;w&quot;</span> + mode) <span class="keyword">as</span> f:</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                f.write(contents)</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;            chmod(target, 0o777 - mask)</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="keyword">def </span>install_eggs(self, spec, dist_filename, tmpdir):</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        <span class="comment"># .egg dirs or files are already built, so just return them</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        <span class="keywordflow">if</span> dist_filename.lower().endswith(<span class="stringliteral">&#39;.egg&#39;</span>):</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;            <span class="keywordflow">return</span> [self.install_egg(dist_filename, tmpdir)]</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        <span class="keywordflow">elif</span> dist_filename.lower().endswith(<span class="stringliteral">&#39;.exe&#39;</span>):</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;            <span class="keywordflow">return</span> [self.install_exe(dist_filename, tmpdir)]</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        <span class="comment"># Anything else, try to extract and build</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;        setup_base = tmpdir</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        <span class="keywordflow">if</span> os.path.isfile(dist_filename) <span class="keywordflow">and</span> <span class="keywordflow">not</span> dist_filename.endswith(<span class="stringliteral">&#39;.py&#39;</span>):</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;            unpack_archive(dist_filename, tmpdir, self.unpack_progress)</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        <span class="keywordflow">elif</span> os.path.isdir(dist_filename):</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            setup_base = os.path.abspath(dist_filename)</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        <span class="keywordflow">if</span> (setup_base.startswith(tmpdir)  <span class="comment"># something we downloaded</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                <span class="keywordflow">and</span> self.build_directory <span class="keywordflow">and</span> spec <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>):</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;            setup_base = self.maybe_move(spec, dist_filename, setup_base)</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <span class="comment"># Find the setup.py file</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        setup_script = os.path.join(setup_base, <span class="stringliteral">&#39;setup.py&#39;</span>)</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(setup_script):</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            setups = glob(os.path.join(setup_base, <span class="stringliteral">&#39;*&#39;</span>, <span class="stringliteral">&#39;setup.py&#39;</span>))</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> setups:</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                <span class="keywordflow">raise</span> DistutilsError(</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                    <span class="stringliteral">&quot;Couldn&#39;t find a setup script in %s&quot;</span> %</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                    os.path.abspath(dist_filename)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                )</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;            <span class="keywordflow">if</span> len(setups) &gt; 1:</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                <span class="keywordflow">raise</span> DistutilsError(</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                    <span class="stringliteral">&quot;Multiple setup scripts in %s&quot;</span> %</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                    os.path.abspath(dist_filename)</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                )</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            setup_script = setups[0]</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        <span class="comment"># Now run it, and return the result</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        <span class="keywordflow">if</span> self.editable:</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;            log.info(self.report_editable(spec, setup_script))</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;            <span class="keywordflow">return</span> []</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            <span class="keywordflow">return</span> self.build_and_install(setup_script, setup_base)</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="keyword">def </span>egg_distribution(self, egg_path):</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <span class="keywordflow">if</span> os.path.isdir(egg_path):</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;            metadata = PathMetadata(egg_path, os.path.join(egg_path,</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                                                           <span class="stringliteral">&#39;EGG-INFO&#39;</span>))</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;            metadata = EggMetadata(zipimport.zipimporter(egg_path))</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <span class="keywordflow">return</span> Distribution.from_filename(egg_path, metadata=metadata)</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <span class="keyword">def </span>install_egg(self, egg_path, tmpdir):</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        destination = os.path.join(</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            self.install_dir,</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;            os.path.basename(egg_path),</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        )</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        destination = os.path.abspath(destination)</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.dry_run:</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;            ensure_directory(destination)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        dist = self.egg_distribution(egg_path)</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> samefile(egg_path, destination):</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;            <span class="keywordflow">if</span> os.path.isdir(destination) <span class="keywordflow">and</span> <span class="keywordflow">not</span> os.path.islink(destination):</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                dir_util.remove_tree(destination, dry_run=self.dry_run)</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;            <span class="keywordflow">elif</span> os.path.exists(destination):</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                self.execute(</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                    os.unlink,</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                    (destination,),</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                    <span class="stringliteral">&quot;Removing &quot;</span> + destination,</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                )</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                new_dist_is_zipped = <span class="keyword">False</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                <span class="keywordflow">if</span> os.path.isdir(egg_path):</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                    <span class="keywordflow">if</span> egg_path.startswith(tmpdir):</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                        f, m = shutil.move, <span class="stringliteral">&quot;Moving&quot;</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                        f, m = shutil.copytree, <span class="stringliteral">&quot;Copying&quot;</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                <span class="keywordflow">elif</span> self.should_unzip(dist):</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                    self.mkpath(destination)</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                    f, m = self.unpack_and_compile, <span class="stringliteral">&quot;Extracting&quot;</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                    new_dist_is_zipped = <span class="keyword">True</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                    <span class="keywordflow">if</span> egg_path.startswith(tmpdir):</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                        f, m = shutil.move, <span class="stringliteral">&quot;Moving&quot;</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                        f, m = shutil.copy2, <span class="stringliteral">&quot;Copying&quot;</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                self.execute(</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                    f,</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                    (egg_path, destination),</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                    (m + <span class="stringliteral">&quot; %s to %s&quot;</span>) % (</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                        os.path.basename(egg_path),</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                        os.path.dirname(destination)</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                    ),</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                )</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                update_dist_caches(</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                    destination,</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                    fix_zipimporter_caches=new_dist_is_zipped,</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                )</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            <span class="keywordflow">except</span> Exception:</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                update_dist_caches(destination, fix_zipimporter_caches=<span class="keyword">False</span>)</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                <span class="keywordflow">raise</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        self.add_output(destination)</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="keywordflow">return</span> self.egg_distribution(destination)</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="keyword">def </span>install_exe(self, dist_filename, tmpdir):</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        <span class="comment"># See if it&#39;s valid, get data</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        cfg = extract_wininst_cfg(dist_filename)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="keywordflow">if</span> cfg <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;            <span class="keywordflow">raise</span> DistutilsError(</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                <span class="stringliteral">&quot;%s is not a valid distutils Windows .exe&quot;</span> % dist_filename</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;            )</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        <span class="comment"># Create a dummy distribution object until we build the real distro</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        dist = Distribution(</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;            <span class="keywordtype">None</span>,</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;            project_name=cfg.get(<span class="stringliteral">&#39;metadata&#39;</span>, <span class="stringliteral">&#39;name&#39;</span>),</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;            version=cfg.get(<span class="stringliteral">&#39;metadata&#39;</span>, <span class="stringliteral">&#39;version&#39;</span>), platform=get_platform(),</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        )</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="comment"># Convert the .exe to an unpacked egg</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        egg_path = os.path.join(tmpdir, dist.egg_name() + <span class="stringliteral">&#39;.egg&#39;</span>)</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        dist.location = egg_path</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        egg_tmp = egg_path + <span class="stringliteral">&#39;.tmp&#39;</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        _egg_info = os.path.join(egg_tmp, <span class="stringliteral">&#39;EGG-INFO&#39;</span>)</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        pkg_inf = os.path.join(_egg_info, <span class="stringliteral">&#39;PKG-INFO&#39;</span>)</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        ensure_directory(pkg_inf)  <span class="comment"># make sure EGG-INFO dir exists</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        dist._provider = PathMetadata(egg_tmp, _egg_info)  <span class="comment"># XXX</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        self.exe_to_egg(dist_filename, egg_tmp)</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="comment"># Write EGG-INFO/PKG-INFO</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(pkg_inf):</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;            f = open(pkg_inf, <span class="stringliteral">&#39;w&#39;</span>)</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;            f.write(<span class="stringliteral">&#39;Metadata-Version: 1.0\n&#39;</span>)</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> cfg.items(<span class="stringliteral">&#39;metadata&#39;</span>):</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                <span class="keywordflow">if</span> k != <span class="stringliteral">&#39;target_version&#39;</span>:</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                    f.write(<span class="stringliteral">&#39;%s: %s\n&#39;</span> % (k.replace(<span class="stringliteral">&#39;_&#39;</span>, <span class="stringliteral">&#39;-&#39;</span>).title(), v))</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            f.close()</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        script_dir = os.path.join(_egg_info, <span class="stringliteral">&#39;scripts&#39;</span>)</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="comment"># delete entry-point scripts to avoid duping</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        self.delete_blockers([</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;            os.path.join(script_dir, args[0])</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;            <span class="keywordflow">for</span> args <span class="keywordflow">in</span> ScriptWriter.get_args(dist)</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        ])</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        <span class="comment"># Build .egg file from tmpdir</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        bdist_egg.make_zipfile(</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;            egg_path, egg_tmp, verbose=self.verbose, dry_run=self.dry_run,</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        )</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        <span class="comment"># install the .egg</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        <span class="keywordflow">return</span> self.install_egg(egg_path, tmpdir)</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="keyword">def </span>exe_to_egg(self, dist_filename, egg_tmp):</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Extract a bdist_wininst to the directories an egg would use&quot;&quot;&quot;</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        <span class="comment"># Check for .pth file and set up prefix translations</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;        prefixes = get_exe_prefixes(dist_filename)</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        to_compile = []</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        native_libs = []</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        top_level = {}</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;        <span class="keyword">def </span>process(src, dst):</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            s = src.lower()</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;            <span class="keywordflow">for</span> old, new <span class="keywordflow">in</span> prefixes:</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                <span class="keywordflow">if</span> s.startswith(old):</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                    src = new + src[len(old):]</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                    parts = src.split(<span class="stringliteral">&#39;/&#39;</span>)</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                    dst = os.path.join(egg_tmp, *parts)</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                    dl = dst.lower()</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                    <span class="keywordflow">if</span> dl.endswith(<span class="stringliteral">&#39;.pyd&#39;</span>) <span class="keywordflow">or</span> dl.endswith(<span class="stringliteral">&#39;.dll&#39;</span>):</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                        parts[-1] = bdist_egg.strip_module(parts[-1])</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                        top_level[os.path.splitext(parts[0])[0]] = 1</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                        native_libs.append(src)</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                    <span class="keywordflow">elif</span> dl.endswith(<span class="stringliteral">&#39;.py&#39;</span>) <span class="keywordflow">and</span> old != <span class="stringliteral">&#39;SCRIPTS/&#39;</span>:</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                        top_level[os.path.splitext(parts[0])[0]] = 1</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                        to_compile.append(dst)</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                    <span class="keywordflow">return</span> dst</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> src.endswith(<span class="stringliteral">&#39;.pth&#39;</span>):</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                log.warn(<span class="stringliteral">&quot;WARNING: can&#39;t process %s&quot;</span>, src)</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        <span class="comment"># extract, tracking .pyd/.dll-&gt;native_libs and .py -&gt; to_compile</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        unpack_archive(dist_filename, egg_tmp, process)</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        stubs = []</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        <span class="keywordflow">for</span> res <span class="keywordflow">in</span> native_libs:</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;            <span class="keywordflow">if</span> res.lower().endswith(<span class="stringliteral">&#39;.pyd&#39;</span>):  <span class="comment"># create stubs for .pyd&#39;s</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                parts = res.split(<span class="stringliteral">&#39;/&#39;</span>)</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                resource = parts[-1]</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                parts[-1] = bdist_egg.strip_module(parts[-1]) + <span class="stringliteral">&#39;.py&#39;</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                pyfile = os.path.join(egg_tmp, *parts)</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                to_compile.append(pyfile)</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                stubs.append(pyfile)</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                bdist_egg.write_stub(resource, pyfile)</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        self.byte_compile(to_compile)  <span class="comment"># compile .py&#39;s</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        bdist_egg.write_safety_flag(</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;            os.path.join(egg_tmp, <span class="stringliteral">&#39;EGG-INFO&#39;</span>),</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;            bdist_egg.analyze_egg(egg_tmp, stubs))  <span class="comment"># write zip-safety flag</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">for</span> name <span class="keywordflow">in</span> <span class="stringliteral">&#39;top_level&#39;</span>, <span class="stringliteral">&#39;native_libs&#39;</span>:</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;            <span class="keywordflow">if</span> locals()[name]:</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                txt = os.path.join(egg_tmp, <span class="stringliteral">&#39;EGG-INFO&#39;</span>, name + <span class="stringliteral">&#39;.txt&#39;</span>)</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(txt):</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                    f = open(txt, <span class="stringliteral">&#39;w&#39;</span>)</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                    f.write(<span class="stringliteral">&#39;\n&#39;</span>.join(locals()[name]) + <span class="stringliteral">&#39;\n&#39;</span>)</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                    f.close()</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    __mv_warning = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="stringliteral">        Because this distribution was installed --multi-version, before you can</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="stringliteral">        import modules from this package in an application, you will need to</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="stringliteral">        &#39;import pkg_resources&#39; and then use a &#39;require()&#39; call similar to one of</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="stringliteral">        these examples, in order to select the desired version:</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="stringliteral">            pkg_resources.require(&quot;%(name)s&quot;)  # latest installed version</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="stringliteral">            pkg_resources.require(&quot;%(name)s==%(version)s&quot;)  # this exact version</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="stringliteral">            pkg_resources.require(&quot;%(name)s&gt;=%(version)s&quot;)  # this version or higher</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    __id_warning = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="stringliteral">        Note also that the installation directory must be on sys.path at runtime for</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="stringliteral">        this to work.  (e.g. by being the application&#39;s script directory, by being on</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="stringliteral">        PYTHONPATH, or by being added to sys.path by your code.)</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>)</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <span class="keyword">def </span>installation_report(self, req, dist, what=&quot;Installed&quot;):</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Helpful installation message for display to package users&quot;&quot;&quot;</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        msg = <span class="stringliteral">&quot;\n%(what)s %(eggloc)s%(extras)s&quot;</span></div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;        <span class="keywordflow">if</span> self.multi_version <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.no_report:</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            msg += <span class="stringliteral">&#39;\n&#39;</span> + self.__mv_warning</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;            <span class="keywordflow">if</span> self.install_dir <span class="keywordflow">not</span> <span class="keywordflow">in</span> map(normalize_path, sys.path):</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                msg += <span class="stringliteral">&#39;\n&#39;</span> + self.__id_warning</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        eggloc = dist.location</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        name = dist.project_name</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        version = dist.version</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        extras = <span class="stringliteral">&#39;&#39;</span>  <span class="comment"># TODO: self.report_extras(req, dist)</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        <span class="keywordflow">return</span> msg % locals()</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    __editable_msg = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="stringliteral">        Extracted editable version of %(spec)s to %(dirname)s</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="stringliteral">        If it uses setuptools in its setup script, you can activate it in</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="stringliteral">        &quot;development&quot; mode by going to that directory and running::</span></div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="stringliteral">            %(python)s setup.py develop</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="stringliteral">        See the setuptools documentation for the &quot;develop&quot; command for more info.</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    <span class="keyword">def </span>report_editable(self, spec, setup_script):</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        dirname = os.path.dirname(setup_script)</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        python = sys.executable</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;\n&#39;</span> + self.__editable_msg % locals()</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    <span class="keyword">def </span>run_setup(self, setup_script, setup_base, args):</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        sys.modules.setdefault(<span class="stringliteral">&#39;distutils.command.bdist_egg&#39;</span>, bdist_egg)</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        sys.modules.setdefault(<span class="stringliteral">&#39;distutils.command.egg_info&#39;</span>, egg_info)</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        args = list(args)</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;        <span class="keywordflow">if</span> self.verbose &gt; 2:</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;            v = <span class="stringliteral">&#39;v&#39;</span> * (self.verbose - 1)</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;            args.insert(0, <span class="stringliteral">&#39;-&#39;</span> + v)</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        <span class="keywordflow">elif</span> self.verbose &lt; 2:</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;            args.insert(0, <span class="stringliteral">&#39;-q&#39;</span>)</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        <span class="keywordflow">if</span> self.dry_run:</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            args.insert(0, <span class="stringliteral">&#39;-n&#39;</span>)</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        log.info(</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;            <span class="stringliteral">&quot;Running %s %s&quot;</span>, setup_script[len(setup_base) + 1:], <span class="stringliteral">&#39; &#39;</span>.join(args)</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        )</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            run_setup(setup_script, args)</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        <span class="keywordflow">except</span> SystemExit <span class="keyword">as</span> v:</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;            <span class="keywordflow">raise</span> DistutilsError(<span class="stringliteral">&quot;Setup script exited with %s&quot;</span> % (v.args[0],))</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    <span class="keyword">def </span>build_and_install(self, setup_script, setup_base):</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        args = [<span class="stringliteral">&#39;bdist_egg&#39;</span>, <span class="stringliteral">&#39;--dist-dir&#39;</span>]</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;        dist_dir = tempfile.mkdtemp(</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;            prefix=<span class="stringliteral">&#39;egg-dist-tmp-&#39;</span>, dir=os.path.dirname(setup_script)</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        )</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;            self._set_fetcher_options(os.path.dirname(setup_script))</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;            args.append(dist_dir)</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            self.run_setup(setup_script, setup_base, args)</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            all_eggs = Environment([dist_dir])</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;            eggs = []</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;            <span class="keywordflow">for</span> key <span class="keywordflow">in</span> all_eggs:</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;                <span class="keywordflow">for</span> dist <span class="keywordflow">in</span> all_eggs[key]:</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                    eggs.append(self.install_egg(dist.location, setup_base))</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> eggs <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.dry_run:</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                log.warn(<span class="stringliteral">&quot;No eggs found in %s (setup script problem?)&quot;</span>,</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                         dist_dir)</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;            <span class="keywordflow">return</span> eggs</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="keywordflow">finally</span>:</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;            rmtree(dist_dir)</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;            log.set_verbosity(self.verbose)  <span class="comment"># restore our log verbosity</span></div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="keyword">def </span>_set_fetcher_options(self, base):</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="stringliteral">        When easy_install is about to run bdist_egg on a source dist, that</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="stringliteral">        source dist might have &#39;setup_requires&#39; directives, requiring</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="stringliteral">        additional fetching. Ensure the fetcher options given to easy_install</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="stringliteral">        are available to that command as well.</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        <span class="comment"># find the fetch options from easy_install and write them out</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        <span class="comment"># to the setup.cfg file.</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        ei_opts = self.distribution.get_option_dict(<span class="stringliteral">&#39;easy_install&#39;</span>).<a class="code" href="namespacecopy.html">copy</a>()</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        fetch_directives = (</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;            <span class="stringliteral">&#39;find_links&#39;</span>, <span class="stringliteral">&#39;site_dirs&#39;</span>, <span class="stringliteral">&#39;index_url&#39;</span>, <span class="stringliteral">&#39;optimize&#39;</span>,</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;            <span class="stringliteral">&#39;site_dirs&#39;</span>, <span class="stringliteral">&#39;allow_hosts&#39;</span>,</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        )</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        fetch_options = {}</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> ei_opts.items():</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">not</span> <span class="keywordflow">in</span> fetch_directives:</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;                <span class="keywordflow">continue</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;            fetch_options[key.replace(<span class="stringliteral">&#39;_&#39;</span>, <span class="stringliteral">&#39;-&#39;</span>)] = val[1]</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;        <span class="comment"># create a settings dictionary suitable for `edit_config`</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        settings = dict(easy_install=fetch_options)</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        cfg_filename = os.path.join(base, <span class="stringliteral">&#39;setup.cfg&#39;</span>)</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        setopt.edit_config(cfg_filename, settings)</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    <span class="keyword">def </span>update_pth(self, dist):</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        <span class="keywordflow">if</span> self.pth_file <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        <span class="keywordflow">for</span> d <span class="keywordflow">in</span> self.pth_file[dist.key]:  <span class="comment"># drop old entries</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;            <span class="keywordflow">if</span> self.multi_version <span class="keywordflow">or</span> d.location != dist.location:</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                log.info(<span class="stringliteral">&quot;Removing %s from easy-install.pth file&quot;</span>, d)</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                self.pth_file.remove(d)</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                <span class="keywordflow">if</span> d.location <span class="keywordflow">in</span> self.shadow_path:</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                    self.shadow_path.remove(d.location)</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.multi_version:</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;            <span class="keywordflow">if</span> dist.location <span class="keywordflow">in</span> self.pth_file.paths:</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                log.info(</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                    <span class="stringliteral">&quot;%s is already the active version in easy-install.pth&quot;</span>,</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                    dist,</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                )</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                log.info(<span class="stringliteral">&quot;Adding %s to easy-install.pth file&quot;</span>, dist)</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                self.pth_file.add(dist)  <span class="comment"># add new entry</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                <span class="keywordflow">if</span> dist.location <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.shadow_path:</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                    self.shadow_path.append(dist.location)</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.dry_run:</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            self.pth_file.save()</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            <span class="keywordflow">if</span> dist.key == <span class="stringliteral">&#39;setuptools&#39;</span>:</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                <span class="comment"># Ensure that setuptools itself never becomes unavailable!</span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                <span class="comment"># XXX should this check for latest version?</span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                filename = os.path.join(self.install_dir, <span class="stringliteral">&#39;setuptools.pth&#39;</span>)</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;                <span class="keywordflow">if</span> os.path.islink(filename):</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;                    os.unlink(filename)</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;                f = open(filename, <span class="stringliteral">&#39;wt&#39;</span>)</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;                f.write(self.pth_file.make_relative(dist.location) + <span class="stringliteral">&#39;\n&#39;</span>)</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                f.close()</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    <span class="keyword">def </span>unpack_progress(self, src, dst):</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <span class="comment"># Progress filter for unpacking</span></div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        log.debug(<span class="stringliteral">&quot;Unpacking %s to %s&quot;</span>, src, dst)</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        <span class="keywordflow">return</span> dst  <span class="comment"># only unpack-and-compile skips files for dry run</span></div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    <span class="keyword">def </span>unpack_and_compile(self, egg_path, destination):</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        to_compile = []</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        to_chmod = []</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        <span class="keyword">def </span>pf(src, dst):</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;            <span class="keywordflow">if</span> dst.endswith(<span class="stringliteral">&#39;.py&#39;</span>) <span class="keywordflow">and</span> <span class="keywordflow">not</span> src.startswith(<span class="stringliteral">&#39;EGG-INFO/&#39;</span>):</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                to_compile.append(dst)</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;            <span class="keywordflow">elif</span> dst.endswith(<span class="stringliteral">&#39;.dll&#39;</span>) <span class="keywordflow">or</span> dst.endswith(<span class="stringliteral">&#39;.so&#39;</span>):</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                to_chmod.append(dst)</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;            self.unpack_progress(src, dst)</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;            <span class="keywordflow">return</span> <span class="keywordflow">not</span> self.dry_run <span class="keywordflow">and</span> dst <span class="keywordflow">or</span> <span class="keywordtype">None</span></div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        unpack_archive(egg_path, destination, pf)</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        self.byte_compile(to_compile)</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.dry_run:</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;            <span class="keywordflow">for</span> f <span class="keywordflow">in</span> to_chmod:</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                mode = ((os.stat(f)[stat.ST_MODE]) | 0o555) &amp; 0o7755</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                chmod(f, mode)</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="keyword">def </span>byte_compile(self, to_compile):</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        <span class="keywordflow">if</span> sys.dont_write_bytecode:</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;            self.warn(<span class="stringliteral">&#39;byte-compiling is disabled, skipping.&#39;</span>)</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <span class="keyword">from</span> distutils.util <span class="keyword">import</span> byte_compile</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;            <span class="comment"># try to make the byte compile messages quieter</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;            log.set_verbosity(self.verbose - 1)</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;            byte_compile(to_compile, optimize=0, force=1, dry_run=self.dry_run)</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;            <span class="keywordflow">if</span> self.optimize:</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                byte_compile(</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                    to_compile, optimize=self.optimize, force=1,</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;                    dry_run=self.dry_run,</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;                )</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;        <span class="keywordflow">finally</span>:</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;            log.set_verbosity(self.verbose)  <span class="comment"># restore original verbosity</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    __no_default_msg = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;<span class="stringliteral">        bad install directory or PYTHONPATH</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="stringliteral">        You are attempting to install a package to a directory that is not</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="stringliteral">        on PYTHONPATH and which Python does not read &quot;.pth&quot; files from.  The</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="stringliteral">        installation directory you specified (via --install-dir, --prefix, or</span></div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="stringliteral">        the distutils default setting) was:</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;<span class="stringliteral">            %s</span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="stringliteral">        and your PYTHONPATH environment variable currently contains:</span></div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="stringliteral">            %r</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="stringliteral">        Here are some of your options for correcting the problem:</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="stringliteral">        * You can choose a different installation directory, i.e., one that is</span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="stringliteral">          on PYTHONPATH or supports .pth files</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="stringliteral">        * You can add the installation directory to the PYTHONPATH environment</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;<span class="stringliteral">          variable.  (It must then also be on PYTHONPATH whenever you run</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="stringliteral">          Python and want to use the package(s) you are installing.)</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;<span class="stringliteral">        * You can set up the installation directory to support &quot;.pth&quot; files by</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="stringliteral">          using one of the approaches described here:</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;<span class="stringliteral">          https://setuptools.readthedocs.io/en/latest/easy_install.html#custom-installation-locations</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;<span class="stringliteral">        Please make the appropriate changes for your system and try again.&quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="keyword">def </span>no_default_version_msg(self):</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;        template = self.__no_default_msg</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;        <span class="keywordflow">return</span> template % (self.install_dir, os.environ.get(<span class="stringliteral">&#39;PYTHONPATH&#39;</span>, <span class="stringliteral">&#39;&#39;</span>))</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    <span class="keyword">def </span>install_site_py(self):</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Make sure there&#39;s a site.py in the target dir, if needed&quot;&quot;&quot;</span></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        <span class="keywordflow">if</span> self.sitepy_installed:</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;            <span class="keywordflow">return</span>  <span class="comment"># already did it, or don&#39;t need to</span></div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;        sitepy = os.path.join(self.install_dir, <span class="stringliteral">&quot;site.py&quot;</span>)</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;        source = resource_string(<span class="stringliteral">&quot;setuptools&quot;</span>, <span class="stringliteral">&quot;site-patch.py&quot;</span>)</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        source = source.decode(<span class="stringliteral">&#39;utf-8&#39;</span>)</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        current = <span class="stringliteral">&quot;&quot;</span></div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <span class="keywordflow">if</span> os.path.exists(sitepy):</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;            log.debug(<span class="stringliteral">&quot;Checking existing site.py in %s&quot;</span>, self.install_dir)</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;            with io.open(sitepy) <span class="keyword">as</span> strm:</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;                current = strm.read()</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> current.startswith(<span class="stringliteral">&#39;def __boot():&#39;</span>):</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                <span class="keywordflow">raise</span> DistutilsError(</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                    <span class="stringliteral">&quot;%s is not a setuptools-generated site.py; please&quot;</span></div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;                    <span class="stringliteral">&quot; remove it.&quot;</span> % sitepy</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;                )</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        <span class="keywordflow">if</span> current != source:</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;            log.info(<span class="stringliteral">&quot;Creating %s&quot;</span>, sitepy)</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.dry_run:</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                ensure_directory(sitepy)</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                with io.open(sitepy, <span class="stringliteral">&#39;w&#39;</span>, encoding=<span class="stringliteral">&#39;utf-8&#39;</span>) <span class="keyword">as</span> strm:</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                    strm.write(source)</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            self.byte_compile([sitepy])</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        self.sitepy_installed = <span class="keyword">True</span></div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="keyword">def </span>create_home_path(self):</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Create directories under ~.&quot;&quot;&quot;</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.user:</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        home = convert_path(os.path.expanduser(<span class="stringliteral">&quot;~&quot;</span>))</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;        <span class="keywordflow">for</span> name, path <span class="keywordflow">in</span> six.iteritems(self.config_vars):</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;            <span class="keywordflow">if</span> path.startswith(home) <span class="keywordflow">and</span> <span class="keywordflow">not</span> os.path.isdir(path):</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                self.debug_print(<span class="stringliteral">&quot;os.makedirs(&#39;%s&#39;, 0o700)&quot;</span> % path)</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                os.makedirs(path, 0o700)</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    INSTALL_SCHEMES = dict(</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        posix=dict(</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;            install_dir=<span class="stringliteral">&#39;$base/lib/python$py_version_short/site-packages&#39;</span>,</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;            script_dir=<span class="stringliteral">&#39;$base/bin&#39;</span>,</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        ),</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;    )</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    DEFAULT_SCHEME = dict(</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        install_dir=<span class="stringliteral">&#39;$base/Lib/site-packages&#39;</span>,</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        script_dir=<span class="stringliteral">&#39;$base/Scripts&#39;</span>,</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    )</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keyword">def </span>_expand(self, *attrs):</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        config_vars = self.get_finalized_command(<span class="stringliteral">&#39;install&#39;</span>).config_vars</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;        <span class="keywordflow">if</span> self.prefix:</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;            <span class="comment"># Set default install_dir/scripts from --prefix</span></div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;            config_vars = config_vars.copy()</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;            config_vars[<span class="stringliteral">&#39;base&#39;</span>] = self.prefix</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;            scheme = self.INSTALL_SCHEMES.get(os.name, self.DEFAULT_SCHEME)</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;            <span class="keywordflow">for</span> attr, val <span class="keywordflow">in</span> scheme.items():</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;                <span class="keywordflow">if</span> getattr(self, attr, <span class="keywordtype">None</span>) <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;                    setattr(self, attr, val)</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;        <span class="keyword">from</span> distutils.util <span class="keyword">import</span> subst_vars</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        <span class="keywordflow">for</span> attr <span class="keywordflow">in</span> attrs:</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;            val = getattr(self, attr)</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;            <span class="keywordflow">if</span> val <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                val = subst_vars(val, config_vars)</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;                <span class="keywordflow">if</span> os.name == <span class="stringliteral">&#39;posix&#39;</span>:</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;                    val = os.path.expanduser(val)</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;                setattr(self, attr, val)</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;<span class="keyword">def </span>_pythonpath():</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    items = os.environ.get(<span class="stringliteral">&#39;PYTHONPATH&#39;</span>, <span class="stringliteral">&#39;&#39;</span>).split(os.pathsep)</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    <span class="keywordflow">return</span> filter(<span class="keywordtype">None</span>, items)</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;<span class="keyword">def </span>get_site_dirs():</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;<span class="stringliteral">    Return a list of &#39;site&#39; dirs</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    sitedirs = []</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    <span class="comment"># start with PYTHONPATH</span></div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    sitedirs.extend(_pythonpath())</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    prefixes = [sys.prefix]</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="keywordflow">if</span> sys.exec_prefix != sys.prefix:</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;        prefixes.append(sys.exec_prefix)</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;    <span class="keywordflow">for</span> prefix <span class="keywordflow">in</span> prefixes:</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        <span class="keywordflow">if</span> prefix:</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;            <span class="keywordflow">if</span> sys.platform <span class="keywordflow">in</span> (<span class="stringliteral">&#39;os2emx&#39;</span>, <span class="stringliteral">&#39;riscos&#39;</span>):</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;                sitedirs.append(os.path.join(prefix, <span class="stringliteral">&quot;Lib&quot;</span>, <span class="stringliteral">&quot;site-packages&quot;</span>))</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;            <span class="keywordflow">elif</span> os.sep == <span class="stringliteral">&#39;/&#39;</span>:</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                sitedirs.extend([</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                    os.path.join(</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                        prefix,</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                        <span class="stringliteral">&quot;lib&quot;</span>,</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                        <span class="stringliteral">&quot;python&quot;</span> + sys.version[:3],</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;                        <span class="stringliteral">&quot;site-packages&quot;</span>,</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                    ),</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;                    os.path.join(prefix, <span class="stringliteral">&quot;lib&quot;</span>, <span class="stringliteral">&quot;site-python&quot;</span>),</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;                ])</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                sitedirs.extend([</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;                    prefix,</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;                    os.path.join(prefix, <span class="stringliteral">&quot;lib&quot;</span>, <span class="stringliteral">&quot;site-packages&quot;</span>),</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;                ])</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;            <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">&#39;darwin&#39;</span>:</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;                <span class="comment"># for framework builds *only* we add the standard Apple</span></div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;                <span class="comment"># locations. Currently only per-user, but /Library and</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;                <span class="comment"># /Network/Library could be added too</span></div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;Python.framework&#39;</span> <span class="keywordflow">in</span> prefix:</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;                    home = os.environ.get(<span class="stringliteral">&#39;HOME&#39;</span>)</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;                    <span class="keywordflow">if</span> home:</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;                        home_sp = os.path.join(</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;                            home,</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                            <span class="stringliteral">&#39;Library&#39;</span>,</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                            <span class="stringliteral">&#39;Python&#39;</span>,</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;                            sys.version[:3],</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;                            <span class="stringliteral">&#39;site-packages&#39;</span>,</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                        )</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                        sitedirs.append(home_sp)</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    lib_paths = get_path(<span class="stringliteral">&#39;purelib&#39;</span>), get_path(<span class="stringliteral">&#39;platlib&#39;</span>)</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    <span class="keywordflow">for</span> site_lib <span class="keywordflow">in</span> lib_paths:</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        <span class="keywordflow">if</span> site_lib <span class="keywordflow">not</span> <span class="keywordflow">in</span> sitedirs:</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;            sitedirs.append(site_lib)</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    <span class="keywordflow">if</span> site.ENABLE_USER_SITE:</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        sitedirs.append(site.USER_SITE)</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        sitedirs.extend(site.getsitepackages())</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    <span class="keywordflow">except</span> AttributeError:</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        <span class="keywordflow">pass</span></div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    sitedirs = list(map(normalize_path, sitedirs))</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <span class="keywordflow">return</span> sitedirs</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;<span class="keyword">def </span>expand_paths(inputs):</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Yield sys.path directories that might contain &quot;old-style&quot; packages&quot;&quot;&quot;</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    seen = {}</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="keywordflow">for</span> dirname <span class="keywordflow">in</span> inputs:</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;        dirname = normalize_path(dirname)</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;        <span class="keywordflow">if</span> dirname <span class="keywordflow">in</span> seen:</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;            <span class="keywordflow">continue</span></div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        seen[dirname] = 1</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.isdir(dirname):</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;            <span class="keywordflow">continue</span></div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        files = os.listdir(dirname)</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        <span class="keywordflow">yield</span> dirname, files</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        <span class="keywordflow">for</span> name <span class="keywordflow">in</span> files:</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> name.endswith(<span class="stringliteral">&#39;.pth&#39;</span>):</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                <span class="comment"># We only care about the .pth files</span></div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                <span class="keywordflow">continue</span></div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;            <span class="keywordflow">if</span> name <span class="keywordflow">in</span> (<span class="stringliteral">&#39;easy-install.pth&#39;</span>, <span class="stringliteral">&#39;setuptools.pth&#39;</span>):</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                <span class="comment"># Ignore .pth files that we control</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;                <span class="keywordflow">continue</span></div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;            <span class="comment"># Read the .pth file</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;            f = open(os.path.join(dirname, name))</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;            lines = list(yield_lines(f))</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;            f.close()</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;            <span class="comment"># Yield existing non-dupe, non-import directory lines from it</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;            <span class="keywordflow">for</span> line <span class="keywordflow">in</span> lines:</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> line.startswith(<span class="stringliteral">&quot;import&quot;</span>):</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;                    line = normalize_path(line.rstrip())</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                    <span class="keywordflow">if</span> line <span class="keywordflow">not</span> <span class="keywordflow">in</span> seen:</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;                        seen[line] = 1</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;                        <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.isdir(line):</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;                            <span class="keywordflow">continue</span></div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;                        <span class="keywordflow">yield</span> line, os.listdir(line)</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="keyword">def </span>extract_wininst_cfg(dist_filename):</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Extract configuration data from a bdist_wininst .exe</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;<span class="stringliteral">    Returns a configparser.RawConfigParser, or None</span></div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    f = open(dist_filename, <span class="stringliteral">&#39;rb&#39;</span>)</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;        endrec = zipfile._EndRecData(f)</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;        <span class="keywordflow">if</span> endrec <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;        prepended = (endrec[9] - endrec[5]) - endrec[6]</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;        <span class="keywordflow">if</span> prepended &lt; 12:  <span class="comment"># no wininst data here</span></div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;        f.seek(prepended - 12)</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;        tag, cfglen, bmlen = struct.unpack(<span class="stringliteral">&quot;&lt;iii&quot;</span>, f.read(12))</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;        <span class="keywordflow">if</span> tag <span class="keywordflow">not</span> <span class="keywordflow">in</span> (0x1234567A, 0x1234567B):</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span>  <span class="comment"># not a valid tag</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;        f.seek(prepended - (12 + cfglen))</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        init = {<span class="stringliteral">&#39;version&#39;</span>: <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;target_version&#39;</span>: <span class="stringliteral">&#39;&#39;</span>}</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        cfg = configparser.RawConfigParser(init)</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;            part = f.read(cfglen)</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;            <span class="comment"># Read up to the first null byte.</span></div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;            config = part.split(b<span class="stringliteral">&#39;\0&#39;</span>, 1)[0]</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;            <span class="comment"># Now the config is in bytes, but for RawConfigParser, it should</span></div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;            <span class="comment">#  be text, so decode it.</span></div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;            config = config.decode(sys.getfilesystemencoding())</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;            cfg.readfp(six.StringIO(config))</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;        <span class="keywordflow">except</span> configparser.Error:</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> cfg.has_section(<span class="stringliteral">&#39;metadata&#39;</span>) <span class="keywordflow">or</span> <span class="keywordflow">not</span> cfg.has_section(<span class="stringliteral">&#39;Setup&#39;</span>):</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;        <span class="keywordflow">return</span> cfg</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;    <span class="keywordflow">finally</span>:</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;        f.close()</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;<span class="keyword">def </span>get_exe_prefixes(exe_filename):</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Get exe-&gt;egg path translations for a given .exe file&quot;&quot;&quot;</span></div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;    prefixes = [</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;        (<span class="stringliteral">&#39;PURELIB/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>),</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;        (<span class="stringliteral">&#39;PLATLIB/pywin32_system32&#39;</span>, <span class="stringliteral">&#39;&#39;</span>),</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;        (<span class="stringliteral">&#39;PLATLIB/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>),</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;        (<span class="stringliteral">&#39;SCRIPTS/&#39;</span>, <span class="stringliteral">&#39;EGG-INFO/scripts/&#39;</span>),</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;        (<span class="stringliteral">&#39;DATA/lib/site-packages&#39;</span>, <span class="stringliteral">&#39;&#39;</span>),</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    ]</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    z = zipfile.ZipFile(exe_filename)</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;        <span class="keywordflow">for</span> info <span class="keywordflow">in</span> z.infolist():</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;            name = info.filename</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;            parts = name.split(<span class="stringliteral">&#39;/&#39;</span>)</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;            <span class="keywordflow">if</span> len(parts) == 3 <span class="keywordflow">and</span> parts[2] == <span class="stringliteral">&#39;PKG-INFO&#39;</span>:</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;                <span class="keywordflow">if</span> parts[1].endswith(<span class="stringliteral">&#39;.egg-info&#39;</span>):</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                    prefixes.insert(0, (<span class="stringliteral">&#39;/&#39;</span>.join(parts[:2]), <span class="stringliteral">&#39;EGG-INFO/&#39;</span>))</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                    <span class="keywordflow">break</span></div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;            <span class="keywordflow">if</span> len(parts) != 2 <span class="keywordflow">or</span> <span class="keywordflow">not</span> name.endswith(<span class="stringliteral">&#39;.pth&#39;</span>):</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                <span class="keywordflow">continue</span></div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;            <span class="keywordflow">if</span> name.endswith(<span class="stringliteral">&#39;-nspkg.pth&#39;</span>):</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;                <span class="keywordflow">continue</span></div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;            <span class="keywordflow">if</span> parts[0].upper() <span class="keywordflow">in</span> (<span class="stringliteral">&#39;PURELIB&#39;</span>, <span class="stringliteral">&#39;PLATLIB&#39;</span>):</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;                contents = z.read(name)</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;                <span class="keywordflow">if</span> six.PY3:</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;                    contents = contents.decode()</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;                <span class="keywordflow">for</span> pth <span class="keywordflow">in</span> yield_lines(contents):</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                    pth = pth.strip().replace(<span class="stringliteral">&#39;\\&#39;</span>, <span class="stringliteral">&#39;/&#39;</span>)</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> pth.startswith(<span class="stringliteral">&#39;import&#39;</span>):</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;                        prefixes.append(((<span class="stringliteral">&#39;%s/%s/&#39;</span> % (parts[0], pth)), <span class="stringliteral">&#39;&#39;</span>))</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;    <span class="keywordflow">finally</span>:</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;        z.close()</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    prefixes = [(x.lower(), y) <span class="keywordflow">for</span> x, y <span class="keywordflow">in</span> prefixes]</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;    prefixes.sort()</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;    prefixes.reverse()</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    <span class="keywordflow">return</span> prefixes</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;<span class="keyword">class </span>PthDistributions(Environment):</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;A .pth file with Distribution paths in it&quot;&quot;&quot;</span></div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;    dirty = <span class="keyword">False</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;    <span class="keyword">def </span>__init__(self, filename, sitedirs=()):</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;        self.filename = filename</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        self.sitedirs = list(map(normalize_path, sitedirs))</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        self.basedir = normalize_path(os.path.dirname(self.filename))</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        self._load()</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        Environment.__init__(self, [], <span class="keywordtype">None</span>, <span class="keywordtype">None</span>)</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;        <span class="keywordflow">for</span> path <span class="keywordflow">in</span> yield_lines(self.paths):</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;            list(map(self.add, find_distributions(path, <span class="keyword">True</span>)))</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    <span class="keyword">def </span>_load(self):</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;        self.paths = []</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;        saw_import = <span class="keyword">False</span></div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;        seen = dict.fromkeys(self.sitedirs)</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;        <span class="keywordflow">if</span> os.path.isfile(self.filename):</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;            f = open(self.filename, <span class="stringliteral">&#39;rt&#39;</span>)</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;            <span class="keywordflow">for</span> line <span class="keywordflow">in</span> f:</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;                <span class="keywordflow">if</span> line.startswith(<span class="stringliteral">&#39;import&#39;</span>):</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;                    saw_import = <span class="keyword">True</span></div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;                    <span class="keywordflow">continue</span></div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;                path = line.rstrip()</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;                self.paths.append(path)</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> path.strip() <span class="keywordflow">or</span> path.strip().startswith(<span class="stringliteral">&#39;#&#39;</span>):</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;                    <span class="keywordflow">continue</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;                <span class="comment"># skip non-existent paths, in case somebody deleted a package</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;                <span class="comment"># manually, and duplicate paths as well</span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;                path = self.paths[-1] = normalize_path(</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;                    os.path.join(self.basedir, path)</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;                )</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(path) <span class="keywordflow">or</span> path <span class="keywordflow">in</span> seen:</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;                    self.paths.pop()  <span class="comment"># skip it</span></div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;                    self.dirty = <span class="keyword">True</span>  <span class="comment"># we cleaned up, so we&#39;re dirty now :)</span></div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;                    <span class="keywordflow">continue</span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;                seen[path] = 1</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;            f.close()</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;        <span class="keywordflow">if</span> self.paths <span class="keywordflow">and</span> <span class="keywordflow">not</span> saw_import:</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;            self.dirty = <span class="keyword">True</span>  <span class="comment"># ensure anything we touch has import wrappers</span></div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;        <span class="keywordflow">while</span> self.paths <span class="keywordflow">and</span> <span class="keywordflow">not</span> self.paths[-1].strip():</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;            self.paths.pop()</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;    <span class="keyword">def </span>save(self):</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Write changed .pth file back to disk&quot;&quot;&quot;</span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.dirty:</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;            <span class="keywordflow">return</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;        rel_paths = list(map(self.make_relative, self.paths))</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;        <span class="keywordflow">if</span> rel_paths:</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;            log.debug(<span class="stringliteral">&quot;Saving %s&quot;</span>, self.filename)</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;            lines = self._wrap_lines(rel_paths)</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;            data = <span class="stringliteral">&#39;\n&#39;</span>.join(lines) + <span class="stringliteral">&#39;\n&#39;</span></div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;            <span class="keywordflow">if</span> os.path.islink(self.filename):</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;                os.unlink(self.filename)</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;            with open(self.filename, <span class="stringliteral">&#39;wt&#39;</span>) <span class="keyword">as</span> f:</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;                f.write(data)</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;        <span class="keywordflow">elif</span> os.path.exists(self.filename):</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;            log.debug(<span class="stringliteral">&quot;Deleting empty %s&quot;</span>, self.filename)</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;            os.unlink(self.filename)</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;        self.dirty = <span class="keyword">False</span></div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;    @staticmethod</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;    <span class="keyword">def </span>_wrap_lines(lines):</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;        <span class="keywordflow">return</span> lines</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;    <span class="keyword">def </span>add(self, dist):</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Add `dist` to the distribution map&quot;&quot;&quot;</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        new_path = (</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;            dist.location <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.paths <span class="keywordflow">and</span> (</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;                dist.location <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.sitedirs <span class="keywordflow">or</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;                <span class="comment"># account for &#39;.&#39; being in PYTHONPATH</span></div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;                dist.location == os.getcwd()</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;            )</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;        )</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;        <span class="keywordflow">if</span> new_path:</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;            self.paths.append(dist.location)</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;            self.dirty = <span class="keyword">True</span></div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;        Environment.add(self, dist)</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    <span class="keyword">def </span>remove(self, dist):</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Remove `dist` from the distribution map&quot;&quot;&quot;</span></div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;        <span class="keywordflow">while</span> dist.location <span class="keywordflow">in</span> self.paths:</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;            self.paths.remove(dist.location)</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;            self.dirty = <span class="keyword">True</span></div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        Environment.remove(self, dist)</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;    <span class="keyword">def </span>make_relative(self, path):</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;        npath, last = os.path.split(normalize_path(path))</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        baselen = len(self.basedir)</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;        parts = [last]</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;        sep = os.altsep == <span class="stringliteral">&#39;/&#39;</span> <span class="keywordflow">and</span> <span class="stringliteral">&#39;/&#39;</span> <span class="keywordflow">or</span> os.sep</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;        <span class="keywordflow">while</span> len(npath) &gt;= baselen:</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;            <span class="keywordflow">if</span> npath == self.basedir:</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;                parts.append(os.curdir)</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;                parts.reverse()</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;                <span class="keywordflow">return</span> sep.join(parts)</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;            npath, last = os.path.split(npath)</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;            parts.append(last)</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;            <span class="keywordflow">return</span> path</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;<span class="keyword">class </span>RewritePthDistributions(PthDistributions):</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;    @classmethod</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;    <span class="keyword">def </span>_wrap_lines(cls, lines):</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        <span class="keywordflow">yield</span> cls.prelude</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> lines:</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;            <span class="keywordflow">yield</span> line</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        <span class="keywordflow">yield</span> cls.postlude</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    prelude = _one_liner(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="stringliteral">        import sys</span></div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="stringliteral">        sys.__plen = len(sys.path)</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>)</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    postlude = _one_liner(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;<span class="stringliteral">        import sys</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;<span class="stringliteral">        new = sys.path[sys.__plen:]</span></div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="stringliteral">        del sys.path[sys.__plen:]</span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="stringliteral">        p = getattr(sys, &#39;__egginsert&#39;, 0)</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="stringliteral">        sys.path[p:p] = new</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="stringliteral">        sys.__egginsert = p + len(new)</span></div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>)</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;<span class="keywordflow">if</span> os.environ.get(<span class="stringliteral">&#39;SETUPTOOLS_SYS_PATH_TECHNIQUE&#39;</span>, <span class="stringliteral">&#39;raw&#39;</span>) == <span class="stringliteral">&#39;rewrite&#39;</span>:</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    PthDistributions = RewritePthDistributions</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="keyword">def </span>_first_line_re():</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;<span class="stringliteral">    Return a regular expression based on first_line_re suitable for matching</span></div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;<span class="stringliteral">    strings.</span></div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;    <span class="keywordflow">if</span> isinstance(first_line_re.pattern, str):</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;        <span class="keywordflow">return</span> first_line_re</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;    <span class="comment"># first_line_re in Python &gt;=3.1.4 and &gt;=3.2.1 is a bytes pattern.</span></div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;    <span class="keywordflow">return</span> re.compile(first_line_re.pattern.decode())</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;<span class="keyword">def </span>auto_chmod(func, arg, exc):</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;    <span class="keywordflow">if</span> func <span class="keywordflow">in</span> [os.unlink, os.remove] <span class="keywordflow">and</span> os.name == <span class="stringliteral">&#39;nt&#39;</span>:</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;        chmod(arg, stat.S_IWRITE)</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;        <span class="keywordflow">return</span> func(arg)</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    et, ev, _ = sys.exc_info()</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;    six.reraise(et, (ev[0], ev[1] + (<span class="stringliteral">&quot; %s %s&quot;</span> % (func, arg))))</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="keyword">def </span>update_dist_caches(dist_path, fix_zipimporter_caches):</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="stringliteral">    Fix any globally cached `dist_path` related data</span></div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;<span class="stringliteral">    `dist_path` should be a path of a newly installed egg distribution (zipped</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="stringliteral">    or unzipped).</span></div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;<span class="stringliteral">    sys.path_importer_cache contains finder objects that have been cached when</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="stringliteral">    importing data from the original distribution. Any such finders need to be</span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="stringliteral">    cleared since the replacement distribution might be packaged differently,</span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="stringliteral">    e.g. a zipped egg distribution might get replaced with an unzipped egg</span></div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="stringliteral">    folder or vice versa. Having the old finders cached may then cause Python</span></div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;<span class="stringliteral">    to attempt loading modules from the replacement distribution using an</span></div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="stringliteral">    incorrect loader.</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="stringliteral">    zipimport.zipimporter objects are Python loaders charged with importing</span></div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;<span class="stringliteral">    data packaged inside zip archives. If stale loaders referencing the</span></div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="stringliteral">    original distribution, are left behind, they can fail to load modules from</span></div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;<span class="stringliteral">    the replacement distribution. E.g. if an old zipimport.zipimporter instance</span></div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;<span class="stringliteral">    is used to load data from a new zipped egg archive, it may cause the</span></div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;<span class="stringliteral">    operation to attempt to locate the requested data in the wrong location -</span></div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<span class="stringliteral">    one indicated by the original distribution&#39;s zip archive directory</span></div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;<span class="stringliteral">    information. Such an operation may then fail outright, e.g. report having</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;<span class="stringliteral">    read a &#39;bad local file header&#39;, or even worse, it may fail silently &amp;</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;<span class="stringliteral">    return invalid data.</span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;<span class="stringliteral">    zipimport._zip_directory_cache contains cached zip archive directory</span></div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;<span class="stringliteral">    information for all existing zipimport.zipimporter instances and all such</span></div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;<span class="stringliteral">    instances connected to the same archive share the same cached directory</span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;<span class="stringliteral">    information.</span></div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;<span class="stringliteral">    If asked, and the underlying Python implementation allows it, we can fix</span></div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;<span class="stringliteral">    all existing zipimport.zipimporter instances instead of having to track</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;<span class="stringliteral">    them down and remove them one by one, by updating their shared cached zip</span></div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;<span class="stringliteral">    archive directory information. This, of course, assumes that the</span></div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;<span class="stringliteral">    replacement distribution is packaged as a zipped egg.</span></div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;<span class="stringliteral">    If not asked to fix existing zipimport.zipimporter instances, we still do</span></div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;<span class="stringliteral">    our best to clear any remaining zipimport.zipimporter related cached data</span></div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;<span class="stringliteral">    that might somehow later get used when attempting to load data from the new</span></div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;<span class="stringliteral">    distribution and thus cause such load operations to fail. Note that when</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;<span class="stringliteral">    tracking down such remaining stale data, we can not catch every conceivable</span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;<span class="stringliteral">    usage from here, and we clear only those that we know of and have found to</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;<span class="stringliteral">    cause problems if left alive. Any remaining caches should be updated by</span></div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;<span class="stringliteral">    whomever is in charge of maintaining them, i.e. they should be ready to</span></div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;<span class="stringliteral">    handle us replacing their zip archives with new distributions at runtime.</span></div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;    <span class="comment"># There are several other known sources of stale zipimport.zipimporter</span></div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    <span class="comment"># instances that we do not clear here, but might if ever given a reason to</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;    <span class="comment"># do so:</span></div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;    <span class="comment"># * Global setuptools pkg_resources.working_set (a.k.a. &#39;master working</span></div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;    <span class="comment"># set&#39;) may contain distributions which may in turn contain their</span></div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    <span class="comment">#   zipimport.zipimporter loaders.</span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    <span class="comment"># * Several zipimport.zipimporter loaders held by local variables further</span></div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    <span class="comment">#   up the function call stack when running the setuptools installation.</span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    <span class="comment"># * Already loaded modules may have their __loader__ attribute set to the</span></div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    <span class="comment">#   exact loader instance used when importing them. Python 3.4 docs state</span></div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    <span class="comment">#   that this information is intended mostly for introspection and so is</span></div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    <span class="comment">#   not expected to cause us problems.</span></div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    normalized_path = normalize_path(dist_path)</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    _uncache(normalized_path, sys.path_importer_cache)</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <span class="keywordflow">if</span> fix_zipimporter_caches:</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;        _replace_zip_directory_cache_data(normalized_path)</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;        <span class="comment"># Here, even though we do not want to fix existing and now stale</span></div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;        <span class="comment"># zipimporter cache information, we still want to remove it. Related to</span></div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;        <span class="comment"># Python&#39;s zip archive directory information cache, we clear each of</span></div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;        <span class="comment"># its stale entries in two phases:</span></div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;        <span class="comment">#   1. Clear the entry so attempting to access zip archive information</span></div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;        <span class="comment">#      via any existing stale zipimport.zipimporter instances fails.</span></div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;        <span class="comment">#   2. Remove the entry from the cache so any newly constructed</span></div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;        <span class="comment">#      zipimport.zipimporter instances do not end up using old stale</span></div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;        <span class="comment">#      zip archive directory information.</span></div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;        <span class="comment"># This whole stale data removal step does not seem strictly necessary,</span></div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;        <span class="comment"># but has been left in because it was done before we started replacing</span></div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;        <span class="comment"># the zip archive directory information cache content if possible, and</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;        <span class="comment"># there are no relevant unit tests that we can depend on to tell us if</span></div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        <span class="comment"># this is really needed.</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;        _remove_and_clear_zip_directory_cache_data(normalized_path)</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="keyword">def </span>_collect_zipimporter_cache_entries(normalized_path, cache):</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="stringliteral">    Return zipimporter cache entry keys related to a given normalized path.</span></div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="stringliteral">    Alternative path spellings (e.g. those using different character case or</span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="stringliteral">    those using alternative path separators) related to the same path are</span></div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="stringliteral">    included. Any sub-path entries are included as well, i.e. those</span></div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="stringliteral">    corresponding to zip archives embedded in other zip archives.</span></div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;    result = []</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    prefix_len = len(normalized_path)</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    <span class="keywordflow">for</span> p <span class="keywordflow">in</span> cache:</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;        np = normalize_path(p)</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;        <span class="keywordflow">if</span> (np.startswith(normalized_path) <span class="keywordflow">and</span></div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;                np[prefix_len:prefix_len + 1] <span class="keywordflow">in</span> (os.sep, <span class="stringliteral">&#39;&#39;</span>)):</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;            result.append(p)</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    <span class="keywordflow">return</span> result</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="keyword">def </span>_update_zipimporter_cache(normalized_path, cache, updater=None):</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;<span class="stringliteral">    Update zipimporter cache data for a given normalized path.</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="stringliteral">    Any sub-path entries are processed as well, i.e. those corresponding to zip</span></div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;<span class="stringliteral">    archives embedded in other zip archives.</span></div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;<span class="stringliteral">    Given updater is a callable taking a cache entry key and the original entry</span></div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;<span class="stringliteral">    (after already removing the entry from the cache), and expected to update</span></div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;<span class="stringliteral">    the entry and possibly return a new one to be inserted in its place.</span></div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;<span class="stringliteral">    Returning None indicates that the entry should not be replaced with a new</span></div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;<span class="stringliteral">    one. If no updater is given, the cache entries are simply removed without</span></div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;<span class="stringliteral">    any additional processing, the same as if the updater simply returned None.</span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    <span class="keywordflow">for</span> p <span class="keywordflow">in</span> _collect_zipimporter_cache_entries(normalized_path, cache):</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;        <span class="comment"># N.B. pypy&#39;s custom zipimport._zip_directory_cache implementation does</span></div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;        <span class="comment"># not support the complete dict interface:</span></div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;        <span class="comment"># * Does not support item assignment, thus not allowing this function</span></div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        <span class="comment">#    to be used only for removing existing cache entries.</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        <span class="comment">#  * Does not support the dict.pop() method, forcing us to use the</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;        <span class="comment">#    get/del patterns instead. For more detailed information see the</span></div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;        <span class="comment">#    following links:</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;        <span class="comment">#      https://github.com/pypa/setuptools/issues/202#issuecomment-202913420</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        <span class="comment">#      https://bitbucket.org/pypy/pypy/src/dd07756a34a41f674c0cacfbc8ae1d4cc9ea2ae4/pypy/module/zipimport/interp_zipimport.py#cl-99</span></div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;        old_entry = cache[p]</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;        del cache[p]</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;        new_entry = updater <span class="keywordflow">and</span> updater(p, old_entry)</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;        <span class="keywordflow">if</span> new_entry <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;            cache[p] = new_entry</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="keyword">def </span>_uncache(normalized_path, cache):</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    _update_zipimporter_cache(normalized_path, cache)</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;<span class="keyword">def </span>_remove_and_clear_zip_directory_cache_data(normalized_path):</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <span class="keyword">def </span>clear_and_remove_cached_zip_archive_directory_data(path, old_entry):</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        old_entry.clear()</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;    _update_zipimporter_cache(</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        normalized_path, zipimport._zip_directory_cache,</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;        updater=clear_and_remove_cached_zip_archive_directory_data)</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;<span class="comment"># PyPy Python implementation does not allow directly writing to the</span></div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;<span class="comment"># zipimport._zip_directory_cache and so prevents us from attempting to correct</span></div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;<span class="comment"># its content. The best we can do there is clear the problematic cache content</span></div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;<span class="comment"># and have PyPy repopulate it as needed. The downside is that if there are any</span></div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;<span class="comment"># stale zipimport.zipimporter instances laying around, attempting to use them</span></div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="comment"># will fail due to not having its zip archive directory information available</span></div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;<span class="comment"># instead of being automatically corrected to use the new correct zip archive</span></div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="comment"># directory information.</span></div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;<span class="keywordflow">if</span> <span class="stringliteral">&#39;__pypy__&#39;</span> <span class="keywordflow">in</span> sys.builtin_module_names:</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    _replace_zip_directory_cache_data = \</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;        _remove_and_clear_zip_directory_cache_data</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    <span class="keyword">def </span>_replace_zip_directory_cache_data(normalized_path):</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;        <span class="keyword">def </span>replace_cached_zip_archive_directory_data(path, old_entry):</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;            <span class="comment"># N.B. In theory, we could load the zip directory information just</span></div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;            <span class="comment"># once for all updated path spellings, and then copy it locally and</span></div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;            <span class="comment"># update its contained path strings to contain the correct</span></div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;            <span class="comment"># spelling, but that seems like a way too invasive move (this cache</span></div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;            <span class="comment"># structure is not officially documented anywhere and could in</span></div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;            <span class="comment"># theory change with new Python releases) for no significant</span></div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;            <span class="comment"># benefit.</span></div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;            old_entry.clear()</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;            zipimport.zipimporter(path)</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;            old_entry.update(zipimport._zip_directory_cache[path])</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;            <span class="keywordflow">return</span> old_entry</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;        _update_zipimporter_cache(</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;            normalized_path, zipimport._zip_directory_cache,</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;            updater=replace_cached_zip_archive_directory_data)</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;<span class="keyword">def </span>is_python(text, filename=&#39;&lt;string&gt;&#39;):</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;    <span class="stringliteral">&quot;Is this string a valid Python script?&quot;</span></div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;        compile(text, filename, <span class="stringliteral">&#39;exec&#39;</span>)</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="keywordflow">except</span> (SyntaxError, TypeError):</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">True</span></div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;<span class="keyword">def </span>is_sh(executable):</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Determine if the specified executable is a .sh (contains a #! line)&quot;&quot;&quot;</span></div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        with io.open(executable, encoding=<span class="stringliteral">&#39;latin-1&#39;</span>) <span class="keyword">as</span> fp:</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;            magic = fp.read(2)</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    <span class="keywordflow">except</span> (OSError, IOError):</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        <span class="keywordflow">return</span> executable</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    <span class="keywordflow">return</span> magic == <span class="stringliteral">&#39;#!&#39;</span></div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="keyword">def </span>nt_quote_arg(arg):</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Quote a command line argument according to Windows parsing rules&quot;&quot;&quot;</span></div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;    <span class="keywordflow">return</span> subprocess.list2cmdline([arg])</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="keyword">def </span>is_python_script(script_text, filename):</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Is this text, as a whole, a Python script? (as opposed to shell/bat/etc.</span></div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    <span class="keywordflow">if</span> filename.endswith(<span class="stringliteral">&#39;.py&#39;</span>) <span class="keywordflow">or</span> filename.endswith(<span class="stringliteral">&#39;.pyw&#39;</span>):</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">True</span>  <span class="comment"># extension says it&#39;s Python</span></div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    <span class="keywordflow">if</span> is_python(script_text, filename):</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">True</span>  <span class="comment"># it&#39;s syntactically valid Python</span></div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    <span class="keywordflow">if</span> script_text.startswith(<span class="stringliteral">&#39;#!&#39;</span>):</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;        <span class="comment"># It begins with a &#39;#!&#39; line, so check if &#39;python&#39; is in it somewhere</span></div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;python&#39;</span> <span class="keywordflow">in</span> script_text.splitlines()[0].lower()</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">False</span>  <span class="comment"># Not any Python I can recognize</span></div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;<span class="keywordflow">try</span>:</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;    <span class="keyword">from</span> os <span class="keyword">import</span> chmod <span class="keyword">as</span> _chmod</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;<span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    <span class="comment"># Jython compatibility</span></div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    <span class="keyword">def </span>_chmod(*args):</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        <span class="keywordflow">pass</span></div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;<span class="keyword">def </span>chmod(path, mode):</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    log.debug(<span class="stringliteral">&quot;changing mode of %s to %o&quot;</span>, path, mode)</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;        _chmod(path, mode)</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;    <span class="keywordflow">except</span> os.error <span class="keyword">as</span> e:</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;        log.debug(<span class="stringliteral">&quot;chmod failed: %s&quot;</span>, e)</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;<span class="keyword">class </span>CommandSpec(list):</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<span class="stringliteral">    A command spec for a #! header, specified as a list of arguments akin to</span></div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;<span class="stringliteral">    those passed to Popen.</span></div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    options = []</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    split_args = dict()</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    @classmethod</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    <span class="keyword">def </span>best(cls):</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;<span class="stringliteral">        Choose the best CommandSpec class based on environmental conditions.</span></div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;        <span class="keywordflow">return</span> cls</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    @classmethod</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    <span class="keyword">def </span>_sys_executable(cls):</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;        _default = os.path.normpath(sys.executable)</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;        <span class="keywordflow">return</span> os.environ.get(<span class="stringliteral">&#39;__PYVENV_LAUNCHER__&#39;</span>, _default)</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;    @classmethod</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;    <span class="keyword">def </span>from_param(cls, param):</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="stringliteral">        Construct a CommandSpec from a parameter to build_scripts, which may</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="stringliteral">        be None.</span></div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;        <span class="keywordflow">if</span> isinstance(param, cls):</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;            <span class="keywordflow">return</span> param</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;        <span class="keywordflow">if</span> isinstance(param, list):</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;            <span class="keywordflow">return</span> cls(param)</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;        <span class="keywordflow">if</span> param <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;            <span class="keywordflow">return</span> cls.from_environment()</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;        <span class="comment"># otherwise, assume it&#39;s a string.</span></div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;        <span class="keywordflow">return</span> cls.from_string(param)</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    @classmethod</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    <span class="keyword">def </span>from_environment(cls):</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;        <span class="keywordflow">return</span> cls([cls._sys_executable()])</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;    @classmethod</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    <span class="keyword">def </span>from_string(cls, string):</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;<span class="stringliteral">        Construct a command spec from a simple string representing a command</span></div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;<span class="stringliteral">        line parseable by shlex.split.</span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;        items = shlex.split(string, **cls.split_args)</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        <span class="keywordflow">return</span> cls(items)</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;    <span class="keyword">def </span>install_options(self, script_text):</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;        self.options = shlex.split(self._extract_options(script_text))</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;        cmdline = subprocess.list2cmdline(self)</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> isascii(cmdline):</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;            self.options[:0] = [<span class="stringliteral">&#39;-x&#39;</span>]</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;    @staticmethod</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;    <span class="keyword">def </span>_extract_options(orig_script):</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;<span class="stringliteral">        Extract any options from the first line of the script.</span></div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;        first = (orig_script + <span class="stringliteral">&#39;\n&#39;</span>).splitlines()[0]</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;        match = _first_line_re().match(first)</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;        options = match.group(1) <span class="keywordflow">or</span> <span class="stringliteral">&#39;&#39;</span> <span class="keywordflow">if</span> match <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;        <span class="keywordflow">return</span> options.strip()</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;    <span class="keyword">def </span>as_header(self):</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;        <span class="keywordflow">return</span> self._render(self + list(self.options))</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    @staticmethod</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;    <span class="keyword">def </span>_strip_quotes(item):</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;        _QUOTES = <span class="stringliteral">&#39;&quot;\&#39;&#39;</span></div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;        <span class="keywordflow">for</span> q <span class="keywordflow">in</span> _QUOTES:</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;            <span class="keywordflow">if</span> item.startswith(q) <span class="keywordflow">and</span> item.endswith(q):</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;                <span class="keywordflow">return</span> item[1:-1]</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;        <span class="keywordflow">return</span> item</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;    @staticmethod</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    <span class="keyword">def </span>_render(items):</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;        cmdline = subprocess.list2cmdline(</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;            CommandSpec._strip_quotes(item.strip()) <span class="keywordflow">for</span> item <span class="keywordflow">in</span> items)</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;#!&#39;</span> + cmdline + <span class="stringliteral">&#39;\n&#39;</span></div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;<span class="comment"># For pbr compat; will be removed in a future version.</span></div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;sys_executable = CommandSpec._sys_executable()</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;<span class="keyword">class </span>WindowsCommandSpec(CommandSpec):</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;    split_args = dict(posix=<span class="keyword">False</span>)</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;<span class="keyword">class </span>ScriptWriter(<a class="code" href="struct__object.html">object</a>):</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;<span class="stringliteral">    Encapsulates behavior around writing entry point scripts for console and</span></div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;<span class="stringliteral">    gui apps.</span></div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    template = textwrap.dedent(<span class="stringliteral">r&quot;&quot;&quot;</span></div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;<span class="stringliteral">        # EASY-INSTALL-ENTRY-SCRIPT: %(spec)r,%(group)r,%(name)r</span></div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;<span class="stringliteral">        __requires__ = %(spec)r</span></div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;<span class="stringliteral">        import re</span></div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;<span class="stringliteral">        import sys</span></div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;<span class="stringliteral">        from pkg_resources import load_entry_point</span></div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;<span class="stringliteral">        if __name__ == &#39;__main__&#39;:</span></div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;<span class="stringliteral">            sys.argv[0] = re.sub(r&#39;(-script\.pyw?|\.exe)?$&#39;, &#39;&#39;, sys.argv[0])</span></div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;<span class="stringliteral">            sys.exit(</span></div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;<span class="stringliteral">                load_entry_point(%(spec)r, %(group)r, %(name)r)()</span></div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;<span class="stringliteral">            )</span></div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;    command_spec_class = CommandSpec</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;    @classmethod</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;    <span class="keyword">def </span>get_script_args(cls, dist, executable=None, wininst=False):</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;        <span class="comment"># for backward compatibility</span></div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;        warnings.warn(<span class="stringliteral">&quot;Use get_args&quot;</span>, DeprecationWarning)</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;        writer = (WindowsScriptWriter <span class="keywordflow">if</span> wininst <span class="keywordflow">else</span> ScriptWriter).best()</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;        header = cls.get_script_header(<span class="stringliteral">&quot;&quot;</span>, executable, wininst)</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;        <span class="keywordflow">return</span> writer.get_args(dist, header)</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;    @classmethod</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;    <span class="keyword">def </span>get_script_header(cls, script_text, executable=None, wininst=False):</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;        <span class="comment"># for backward compatibility</span></div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;        warnings.warn(<span class="stringliteral">&quot;Use get_header&quot;</span>, DeprecationWarning)</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;        <span class="keywordflow">if</span> wininst:</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;            executable = <span class="stringliteral">&quot;python.exe&quot;</span></div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;        cmd = cls.command_spec_class.best().from_param(executable)</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;        cmd.install_options(script_text)</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;        <span class="keywordflow">return</span> cmd.as_header()</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;    @classmethod</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;    <span class="keyword">def </span>get_args(cls, dist, header=None):</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;<span class="stringliteral">        Yield write_script() argument tuples for a distribution&#39;s</span></div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;<span class="stringliteral">        console_scripts and gui_scripts entry points.</span></div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;        <span class="keywordflow">if</span> header <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;            header = cls.get_header()</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;        spec = str(dist.as_requirement())</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;        <span class="keywordflow">for</span> type_ <span class="keywordflow">in</span> <span class="stringliteral">&#39;console&#39;</span>, <span class="stringliteral">&#39;gui&#39;</span>:</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;            group = type_ + <span class="stringliteral">&#39;_scripts&#39;</span></div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;            <span class="keywordflow">for</span> name, ep <span class="keywordflow">in</span> dist.get_entry_map(group).items():</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                cls._ensure_safe_name(name)</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;                script_text = cls.template % locals()</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                args = cls._get_script_args(type_, name, header, script_text)</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;                <span class="keywordflow">for</span> res <span class="keywordflow">in</span> args:</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;                    <span class="keywordflow">yield</span> res</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    @staticmethod</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    <span class="keyword">def </span>_ensure_safe_name(name):</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;<span class="stringliteral">        Prevent paths in *_scripts entry point names.</span></div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;        has_path_sep = re.search(<span class="stringliteral">r&#39;[\\/]&#39;</span>, name)</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;        <span class="keywordflow">if</span> has_path_sep:</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;            <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Path separators not allowed in script names&quot;</span>)</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;    @classmethod</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;    <span class="keyword">def </span>get_writer(cls, force_windows):</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;        <span class="comment"># for backward compatibility</span></div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;        warnings.warn(<span class="stringliteral">&quot;Use best&quot;</span>, DeprecationWarning)</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        <span class="keywordflow">return</span> WindowsScriptWriter.best() <span class="keywordflow">if</span> force_windows <span class="keywordflow">else</span> cls.best()</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;    @classmethod</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;    <span class="keyword">def </span>best(cls):</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;<span class="stringliteral">        Select the best ScriptWriter for this environment.</span></div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;        <span class="keywordflow">if</span> sys.platform == <span class="stringliteral">&#39;win32&#39;</span> <span class="keywordflow">or</span> (os.name == <span class="stringliteral">&#39;java&#39;</span> <span class="keywordflow">and</span> os._name == <span class="stringliteral">&#39;nt&#39;</span>):</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;            <span class="keywordflow">return</span> WindowsScriptWriter.best()</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;            <span class="keywordflow">return</span> cls</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;    @classmethod</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;    <span class="keyword">def </span>_get_script_args(cls, type_, name, header, script_text):</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;        <span class="comment"># Simply write the stub with no extension.</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;        <span class="keywordflow">yield</span> (name, header + script_text)</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;    @classmethod</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;    <span class="keyword">def </span>get_header(cls, script_text=&quot;&quot;, executable=None):</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Create a #! line, getting options (if any) from script_text&quot;&quot;&quot;</span></div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;        cmd = cls.command_spec_class.best().from_param(executable)</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;        cmd.install_options(script_text)</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;        <span class="keywordflow">return</span> cmd.as_header()</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;<span class="keyword">class </span>WindowsScriptWriter(ScriptWriter):</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    command_spec_class = WindowsCommandSpec</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;    @classmethod</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;    <span class="keyword">def </span>get_writer(cls):</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;        <span class="comment"># for backward compatibility</span></div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;        warnings.warn(<span class="stringliteral">&quot;Use best&quot;</span>, DeprecationWarning)</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;        <span class="keywordflow">return</span> cls.best()</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;    @classmethod</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;    <span class="keyword">def </span>best(cls):</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;<span class="stringliteral">        Select the best ScriptWriter suitable for Windows</span></div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;        writer_lookup = dict(</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;            executable=WindowsExecutableLauncherWriter,</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;            natural=cls,</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;        )</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;        <span class="comment"># for compatibility, use the executable launcher by default</span></div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;        launcher = os.environ.get(<span class="stringliteral">&#39;SETUPTOOLS_LAUNCHER&#39;</span>, <span class="stringliteral">&#39;executable&#39;</span>)</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;        <span class="keywordflow">return</span> writer_lookup[launcher]</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    @classmethod</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;    <span class="keyword">def </span>_get_script_args(cls, type_, name, header, script_text):</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;        <span class="stringliteral">&quot;For Windows, add a .py extension&quot;</span></div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;        ext = dict(console=<span class="stringliteral">&#39;.pya&#39;</span>, gui=<span class="stringliteral">&#39;.pyw&#39;</span>)[type_]</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;        <span class="keywordflow">if</span> ext <span class="keywordflow">not</span> <span class="keywordflow">in</span> os.environ[<span class="stringliteral">&#39;PATHEXT&#39;</span>].lower().split(<span class="stringliteral">&#39;;&#39;</span>):</div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;            msg = (</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                <span class="stringliteral">&quot;{ext} not listed in PATHEXT; scripts will not be &quot;</span></div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;                <span class="stringliteral">&quot;recognized as executables.&quot;</span></div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;            ).format(**locals())</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;            warnings.warn(msg, UserWarning)</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;        old = [<span class="stringliteral">&#39;.pya&#39;</span>, <span class="stringliteral">&#39;.py&#39;</span>, <span class="stringliteral">&#39;-script.py&#39;</span>, <span class="stringliteral">&#39;.pyc&#39;</span>, <span class="stringliteral">&#39;.pyo&#39;</span>, <span class="stringliteral">&#39;.pyw&#39;</span>, <span class="stringliteral">&#39;.exe&#39;</span>]</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;        old.remove(ext)</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;        header = cls._adjust_header(type_, header)</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;        blockers = [name + x <span class="keywordflow">for</span> x <span class="keywordflow">in</span> old]</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;        <span class="keywordflow">yield</span> name + ext, header + script_text, <span class="stringliteral">&#39;t&#39;</span>, blockers</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    @classmethod</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    <span class="keyword">def </span>_adjust_header(cls, type_, orig_header):</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;<span class="stringliteral">        Make sure &#39;pythonw&#39; is used for gui and and &#39;python&#39; is used for</span></div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;<span class="stringliteral">        console (regardless of what sys.executable is).</span></div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;        pattern = <span class="stringliteral">&#39;pythonw.exe&#39;</span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;        repl = <span class="stringliteral">&#39;python.exe&#39;</span></div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;        <span class="keywordflow">if</span> type_ == <span class="stringliteral">&#39;gui&#39;</span>:</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;            pattern, repl = repl, pattern</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;        pattern_ob = re.compile(re.escape(pattern), re.IGNORECASE)</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;        new_header = pattern_ob.sub(string=orig_header, repl=repl)</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;        <span class="keywordflow">return</span> new_header <span class="keywordflow">if</span> cls._use_header(new_header) <span class="keywordflow">else</span> orig_header</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;    @staticmethod</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;    <span class="keyword">def </span>_use_header(new_header):</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;<span class="stringliteral">        Should _adjust_header use the replaced header?</span></div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;<span class="stringliteral">        On non-windows systems, always use. On</span></div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;<span class="stringliteral">        Windows systems, only use the replaced header if it resolves</span></div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;<span class="stringliteral">        to an executable on the system.</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;        clean_header = new_header[2:-1].strip(<span class="stringliteral">&#39;&quot;&#39;</span>)</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;        <span class="keywordflow">return</span> sys.platform != <span class="stringliteral">&#39;win32&#39;</span> <span class="keywordflow">or</span> find_executable(clean_header)</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;<span class="keyword">class </span>WindowsExecutableLauncherWriter(WindowsScriptWriter):</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;    @classmethod</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;    <span class="keyword">def </span>_get_script_args(cls, type_, name, header, script_text):</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;<span class="stringliteral">        For Windows, add a .py extension and an .exe launcher</span></div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;        <span class="keywordflow">if</span> type_ == <span class="stringliteral">&#39;gui&#39;</span>:</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;            launcher_type = <span class="stringliteral">&#39;gui&#39;</span></div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;            ext = <span class="stringliteral">&#39;-script.pyw&#39;</span></div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;            old = [<span class="stringliteral">&#39;.pyw&#39;</span>]</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;            launcher_type = <span class="stringliteral">&#39;cli&#39;</span></div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;            ext = <span class="stringliteral">&#39;-script.py&#39;</span></div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;            old = [<span class="stringliteral">&#39;.py&#39;</span>, <span class="stringliteral">&#39;.pyc&#39;</span>, <span class="stringliteral">&#39;.pyo&#39;</span>]</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;        hdr = cls._adjust_header(type_, header)</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;        blockers = [name + x <span class="keywordflow">for</span> x <span class="keywordflow">in</span> old]</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;        <span class="keywordflow">yield</span> (name + ext, hdr + script_text, <span class="stringliteral">&#39;t&#39;</span>, blockers)</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;        <span class="keywordflow">yield</span> (</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;            name + <span class="stringliteral">&#39;.exe&#39;</span>, get_win_launcher(launcher_type),</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;            <span class="stringliteral">&#39;b&#39;</span>  <span class="comment"># write in binary mode</span></div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;        )</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> is_64bit():</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;            <span class="comment"># install a manifest for the launcher to prevent Windows</span></div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;            <span class="comment"># from detecting it as an installer (which it will for</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;            <span class="comment">#  launchers like easy_install.exe). Consider only</span></div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;            <span class="comment">#  adding a manifest for launchers detected as installers.</span></div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;            <span class="comment">#  See Distribute #143 for details.</span></div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;            m_name = name + <span class="stringliteral">&#39;.exe.manifest&#39;</span></div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;            <span class="keywordflow">yield</span> (m_name, load_launcher_manifest(name), <span class="stringliteral">&#39;t&#39;</span>)</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;<span class="comment"># for backward-compatibility</span></div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;get_script_args = ScriptWriter.get_script_args</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;get_script_header = ScriptWriter.get_script_header</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;<span class="keyword">def </span>get_win_launcher(type):</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;<span class="stringliteral">    Load the Windows launcher (executable) suitable for launching a script.</span></div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;<span class="stringliteral">    `type` should be either &#39;cli&#39; or &#39;gui&#39;</span></div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;<span class="stringliteral">    Returns the executable as a byte string.</span></div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;    launcher_fn = <span class="stringliteral">&#39;%s.exe&#39;</span> % type</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;    <span class="keywordflow">if</span> is_64bit():</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;        launcher_fn = launcher_fn.replace(<span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;-64.&quot;</span>)</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;        launcher_fn = launcher_fn.replace(<span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;-32.&quot;</span>)</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;    <span class="keywordflow">return</span> resource_string(<span class="stringliteral">&#39;setuptools&#39;</span>, launcher_fn)</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;<span class="keyword">def </span>load_launcher_manifest(name):</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;    manifest = pkg_resources.resource_string(__name__, <span class="stringliteral">&#39;launcher manifest.xml&#39;</span>)</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;    <span class="keywordflow">if</span> six.PY2:</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;        <span class="keywordflow">return</span> manifest % vars()</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;        <span class="keywordflow">return</span> manifest.decode(<span class="stringliteral">&#39;utf-8&#39;</span>) % vars()</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;<span class="keyword">def </span>rmtree(path, ignore_errors=False, onerror=auto_chmod):</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;    <span class="keywordflow">return</span> shutil.rmtree(path, ignore_errors, onerror)</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;<span class="keyword">def </span>current_umask():</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;    tmp = os.umask(0o022)</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;    os.umask(tmp)</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;    <span class="keywordflow">return</span> tmp</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="keyword">def </span>bootstrap():</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;    <span class="comment"># This function is called when setuptools*.egg is run using /bin/sh</span></div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;    <span class="keyword">import</span> setuptools</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;    argv0 = os.path.dirname(setuptools.__path__[0])</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;    sys.argv[0] = argv0</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;    sys.argv.append(argv0)</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;    main()</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;<span class="keyword">def </span>main(argv=None, **kw):</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;    <span class="keyword">from</span> setuptools <span class="keyword">import</span> setup</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;    <span class="keyword">from</span> <a class="code" href="namespacesetuptools_1_1dist.html">setuptools.dist</a> <span class="keyword">import</span> Distribution</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;    <span class="keyword">class </span>DistributionWithoutHelpCommands(Distribution):</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;        common_usage = <span class="stringliteral">&quot;&quot;</span></div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        <span class="keyword">def </span>_show_help(self, *args, **kw):</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;            with _patch_usage():</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;                Distribution._show_help(self, *args, **kw)</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;    <span class="keywordflow">if</span> argv <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;        argv = sys.argv[1:]</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;    with _patch_usage():</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;        <a class="code" href="namespacesetup.html">setup</a>(</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;            script_args=[<span class="stringliteral">&#39;-q&#39;</span>, <span class="stringliteral">&#39;easy_install&#39;</span>, <span class="stringliteral">&#39;-v&#39;</span>] + argv,</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;            script_name=sys.argv[0] <span class="keywordflow">or</span> <span class="stringliteral">&#39;easy_install&#39;</span>,</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;            distclass=DistributionWithoutHelpCommands,</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;            **kw</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;        )</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;@contextlib.contextmanager</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;<span class="keyword">def </span>_patch_usage():</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;    <span class="keyword">import</span> distutils.core</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;    USAGE = textwrap.dedent(<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;<span class="stringliteral">        usage: %(script)s [options] requirement_or_url ...</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="stringliteral">           or: %(script)s --help</span></div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span>).lstrip()</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;    <span class="keyword">def </span>gen_usage(script_name):</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;        <span class="keywordflow">return</span> USAGE % dict(</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;            script=os.path.basename(script_name),</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;        )</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;    saved = distutils.core.gen_usage</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    distutils.core.gen_usage = gen_usage</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;        <span class="keywordflow">yield</span></div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;    <span class="keywordflow">finally</span>:</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;        distutils.core.gen_usage = saved</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<div class="ttc" id="namespacesetuptools_1_1command_html"><div class="ttname"><a href="namespacesetuptools_1_1command.html">setuptools.command</a></div><div class="ttdef"><b>Definition:</b> <a href="OPTI_2bzfdinse_2appfs_2Dinsel_2venv_2lib_2python3_85_2site-packages_2setuptools_2command_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="namespacesetup_html"><div class="ttname"><a href="namespacesetup.html">setup</a></div><div class="ttdef"><b>Definition:</b> <a href="ex1_2setup_8py_source.html#l00001">setup.py:1</a></div></div>
<div class="ttc" id="namespaceeasy__install_html"><div class="ttname"><a href="namespaceeasy__install.html">easy_install</a></div><div class="ttdef"><b>Definition:</b> <a href="easy__install_8py_source.html#l00001">easy_install.py:1</a></div></div>
<div class="ttc" id="namespacesetuptools_1_1dist_html"><div class="ttname"><a href="namespacesetuptools_1_1dist.html">setuptools.dist</a></div><div class="ttdef"><b>Definition:</b> <a href="dist_8py_source.html#l00001">dist.py:1</a></div></div>
<div class="ttc" id="namespacesetuptools_1_1py27compat_html"><div class="ttname"><a href="namespacesetuptools_1_1py27compat.html">setuptools.py27compat</a></div><div class="ttdef"><b>Definition:</b> <a href="py27compat_8py_source.html#l00001">py27compat.py:1</a></div></div>
<div class="ttc" id="namespacesetuptools_1_1package__index_html"><div class="ttname"><a href="namespacesetuptools_1_1package__index.html">setuptools.package_index</a></div><div class="ttdef"><b>Definition:</b> <a href="package__index_8py_source.html#l00001">package_index.py:1</a></div></div>
<div class="ttc" id="namespacesetuptools_1_1archive__util_html"><div class="ttname"><a href="namespacesetuptools_1_1archive__util.html">setuptools.archive_util</a></div><div class="ttdef"><b>Definition:</b> <a href="archive__util_8py_source.html#l00001">archive_util.py:1</a></div></div>
<div class="ttc" id="namespacesetuptools_1_1sandbox_html"><div class="ttname"><a href="namespacesetuptools_1_1sandbox.html">setuptools.sandbox</a></div><div class="ttdef"><b>Definition:</b> <a href="sandbox_8py_source.html#l00001">sandbox.py:1</a></div></div>
<div class="ttc" id="namespacecopy_html"><div class="ttname"><a href="namespacecopy.html">copy</a></div><div class="ttdef"><b>Definition:</b> <a href="copy_8py_source.html#l00001">copy.py:1</a></div></div>
<div class="ttc" id="struct__object_html"><div class="ttname"><a href="struct__object.html">_object</a></div><div class="ttdef"><b>Definition:</b> <a href="object_8h_source.html#l00106">object.h:106</a></div></div>
<div class="ttc" id="namespacesetuptools_1_1extern_html"><div class="ttname"><a href="namespacesetuptools_1_1extern.html">setuptools.extern</a></div><div class="ttdef"><b>Definition:</b> <a href="OPTI_2bzfdinse_2appfs_2Dinsel_2venv_2lib_2python3_85_2site-packages_2setuptools_2extern_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="namespacesetuptools_1_1py31compat_html"><div class="ttname"><a href="namespacesetuptools_1_1py31compat.html">setuptools.py31compat</a></div><div class="ttdef"><b>Definition:</b> <a href="py31compat_8py_source.html#l00001">py31compat.py:1</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
